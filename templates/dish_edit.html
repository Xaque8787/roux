{% extends "base.html" %}

{% block title %}Edit {{ dish.name }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-edit"></i> Edit Dish: {{ dish.name }}</h1>
        <a href="/dishes/{{ dish.id }}" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Dish
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-edit"></i> Dish Information</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/dishes/{{ dish.id }}/edit" id="dishEditForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Dish Name</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ dish.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Category</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if dish.category_id == cat.id %}selected{% endif %}>
                                        {{ cat.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sale_price" class="form-label">Sale Price</label>
                                <input type="number" class="form-control" id="sale_price" name="sale_price" 
                                       step="0.01" value="{{ dish.sale_price }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ dish.description or '' }}</textarea>
                    </div>
                    
                    <h6>Batch Portions:</h6>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="batchSearch" 
                                   placeholder="Search for batches..." autocomplete="off">
                            <button type="button" class="btn btn-outline-secondary" id="addBatchBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="batchSuggestions" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="selectedBatches" class="mb-3">
                        <!-- Selected batches will appear here -->
                    </div>
                    
                    <input type="hidden" name="batch_portions_data" id="batchPortionsData">
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="/dishes/{{ dish.id }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let selectedBatches = [];
let currentBatchData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Load existing batch portions
    {% for portion in dish_batch_portions %}
    selectedBatches.push({
        batch_id: {{ portion.batch_id }},
        recipe_name: "{{ portion.batch.recipe.name }}",
        yield_unit: "{{ portion.batch.yield_unit.name if portion.batch.yield_unit else '' }}",
        portion_size: {{ portion.portion_size }},
        estimated_cost: {{ portion.cost }}
    });
    {% endfor %}
    
    updateSelectedBatchesDisplay();
    
    const batchSearch = document.getElementById('batchSearch');
    const suggestions = document.getElementById('batchSuggestions');
    
    let searchTimeout;
    
    // Search batches as user types
    batchSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/batches/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayBatchSuggestions(data);
                })
                .catch(error => console.error('Error:', error));
        }, 300);
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#batchSearch') && !e.target.closest('#batchSuggestions')) {
            suggestions.style.display = 'none';
        }
    });
    
    // Form submission
    document.getElementById('dishEditForm').addEventListener('submit', function(e) {
        document.getElementById('batchPortionsData').value = JSON.stringify(selectedBatches);
    });
});

function displayBatchSuggestions(batches) {
    const suggestions = document.getElementById('batchSuggestions');
    
    if (batches.length === 0) {
        suggestions.style.display = 'none';
        return;
    }
    
    suggestions.innerHTML = '';
    batches.forEach(batch => {
        const item = document.createElement('a');
        item.className = 'dropdown-item';
        item.href = '#';
        item.innerHTML = `
            <strong>${batch.recipe_name}</strong><br>
            <small>Yield: ${batch.yield_amount} ${batch.yield_unit} - $${batch.cost_per_unit.toFixed(4)}/unit</small>
            ${batch.category ? `<br><small class="text-muted">${batch.category}</small>` : ''}
        `;
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            selectBatch(batch);
        });
        
        suggestions.appendChild(item);
    });
    
    suggestions.style.display = 'block';
}

function selectBatch(batch) {
    // Check if batch already selected
    if (selectedBatches.find(sb => sb.batch_id === batch.id)) {
        alert('This batch is already added to the dish.');
        return;
    }
    
    currentBatchData = batch;
    document.getElementById('batchSearch').value = batch.recipe_name;
    document.getElementById('batchSuggestions').style.display = 'none';
    
    // Show portion size selection
    showPortionSizeSelection(batch);
}

function showPortionSizeSelection(batch) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ${batch.recipe_name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Batch Details</label>
                        <p class="text-muted">Yield: ${batch.yield_amount} ${batch.yield_unit}<br>
                        Cost per ${batch.yield_unit}: $${batch.cost_per_unit.toFixed(4)}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Portion Size</label>
                        <input type="number" class="form-control" id="portionSizeInput" step="0.01" min="0" required>
                        <small class="text-muted">Enter portion size in ${batch.yield_unit}</small>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estimated cost: $<span id="estimatedPortionCost">0.00</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addBatchToDish()">Add Batch</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Update cost estimate when portion size changes
    const portionSizeInput = modal.querySelector('#portionSizeInput');
    const estimatedCost = modal.querySelector('#estimatedPortionCost');
    
    function updatePortionCost() {
        const portionSize = parseFloat(portionSizeInput.value) || 0;
        const cost = portionSize * batch.cost_per_unit;
        estimatedCost.textContent = cost.toFixed(2);
    }
    
    portionSizeInput.addEventListener('input', updatePortionCost);
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addBatchToDish() {
    const portionSizeInput = document.querySelector('#portionSizeInput');
    
    const portionSize = parseFloat(portionSizeInput.value);
    if (!portionSize || portionSize <= 0) {
        alert('Please enter a valid portion size.');
        return;
    }
    
    const estimatedCost = portionSize * currentBatchData.cost_per_unit;
    
    // Add to selected batches
    selectedBatches.push({
        batch_id: currentBatchData.id,
        recipe_name: currentBatchData.recipe_name,
        yield_unit: currentBatchData.yield_unit,
        portion_size: portionSize,
        estimated_cost: estimatedCost
    });
    
    // Update display
    updateSelectedBatchesDisplay();
    
    // Clear search
    document.getElementById('batchSearch').value = '';
    
    // Close modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
}

function updateSelectedBatchesDisplay() {
    const container = document.getElementById('selectedBatches');
    
    if (selectedBatches.length === 0) {
        container.innerHTML = '<p class="text-muted">No batches added yet.</p>';
        return;
    }
    
    let html = '<h6>Selected Batches:</h6>';
    let totalCost = 0;
    
    selectedBatches.forEach((batch, index) => {
        totalCost += batch.estimated_cost;
        html += `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${batch.recipe_name}</strong><br>
                            <small>${batch.portion_size} ${batch.yield_unit} - $${batch.estimated_cost.toFixed(2)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeBatch(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `<div class="alert alert-info"><strong>Estimated Total Cost: $${totalCost.toFixed(2)}</strong></div>`;
    container.innerHTML = html;
}

function removeBatch(index) {
    selectedBatches.splice(index, 1);
    updateSelectedBatchesDisplay();
}
</script>
{% endblock %}