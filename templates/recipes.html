{% extends "base.html" %}

{% block title %}Recipes - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-book"></i> Recipes</h1>
    </div>
</div>

<div class="row mt-3">
    {% if current_user.role in ["admin", "manager"] %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Create New Recipe</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/recipes/new" id="recipeForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Recipe Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <div class="input-group">
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">Select Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <h6>Ingredients:</h6>
                    <div class="mb-3">
                        <label for="ingredientSelect" class="form-label">Select Ingredient</label>
                        <select class="form-select" id="ingredientSelect">
                            <option value="">Choose an ingredient...</option>
                        </select>
                    </div>
                    
                    <div id="selectedIngredients" class="mb-3">
                        <!-- Selected ingredients will appear here -->
                    </div>
                    
                    <input type="hidden" name="ingredients_data" id="ingredientsData">
                    
                    <button type="submit" class="btn btn-success mt-3">
                        <i class="fas fa-plus"></i> Create Recipe
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="{% if current_user.role in ['admin', 'manager'] %}col-md-6{% else %}col-12{% endif %}">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Recipes List</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for recipe in recipes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ recipe.name }}</strong>
                            {% if recipe.category %}
                            <br><small class="text-muted">{{ recipe.category.name }}</small>
                            {% endif %}
                        </div>
                        <div>
                            <a href="/recipes/{{ recipe.id }}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if current_user.role in ["admin", "manager"] %}
                            <a href="/recipes/{{ recipe.id }}/edit" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% endif %}
                            {% if current_user.role == "admin" %}
                            <a href="/recipes/{{ recipe.id }}/delete" class="btn btn-sm btn-danger" 
                               onclick="return confirm('Are you sure?')">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/categories/new">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" name="name" required>
                        <input type="hidden" name="type" value="recipe">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectedIngredients = [];
let allIngredients = [];

document.addEventListener('DOMContentLoaded', function() {
    // Load all ingredients for dropdown
    loadAllIngredients();
    
    const ingredientSelect = document.getElementById('ingredientSelect');
    ingredientSelect.addEventListener('change', function() {
        if (this.value) {
            const ingredient = allIngredients.find(ing => ing.id == this.value);
            if (ingredient) {
                selectIngredient(ingredient);
                this.value = ''; // Reset dropdown
            }
        }
    });
    
    // Form submission
    document.getElementById('recipeForm').addEventListener('submit', function(e) {
        document.getElementById('ingredientsData').value = JSON.stringify(selectedIngredients);
    });
});

async function loadAllIngredients() {
    try {
        const response = await fetch('/api/ingredients/all');
        allIngredients = await response.json();
        
        const select = document.getElementById('ingredientSelect');
        select.innerHTML = '<option value="">Choose an ingredient...</option>';
        
        allIngredients.forEach(ingredient => {
            const option = document.createElement('option');
            option.value = ingredient.id;
            option.textContent = `${ingredient.name}${ingredient.category ? ` (${ingredient.category})` : ''}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading ingredients:', error);
    }
}

function selectIngredient(ingredient) {
    // Check if ingredient already selected
    if (selectedIngredients.find(si => si.ingredient_id === ingredient.id)) {
        alert('This ingredient is already added to the recipe.');
        return;
    }
    
    // Show usage unit selection
    showUsageUnitSelection(ingredient);
}

function showUsageUnitSelection(ingredient) {
    if (ingredient.usage_units.length === 0) {
        alert('This ingredient has no usage units defined. Please edit the ingredient first.');
        return;
    }
    
    let usageUnitOptions = '';
    ingredient.usage_units.forEach(unit => {
        usageUnitOptions += `<option value="${unit.id}" data-price="${unit.price_per_unit}">${unit.name} ($${unit.price_per_unit}/unit)</option>`;
    });
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ${ingredient.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Usage Unit</label>
                        <select class="form-select" id="usageUnitSelect">
                            ${usageUnitOptions}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantityInput" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estimated cost: $<span id="estimatedCost">0.00</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addIngredientToRecipe()">Add Ingredient</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Update cost estimate when quantity or unit changes
    const quantityInput = modal.querySelector('#quantityInput');
    const usageUnitSelect = modal.querySelector('#usageUnitSelect');
    const estimatedCost = modal.querySelector('#estimatedCost');
    let currentIngredientData = ingredient;
    
    function updateCost() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const selectedOption = usageUnitSelect.selectedOptions[0];
        const price = parseFloat(selectedOption.dataset.price) || 0;
        estimatedCost.textContent = (quantity * price).toFixed(2);
    }
    
    quantityInput.addEventListener('input', updateCost);
    usageUnitSelect.addEventListener('change', updateCost);
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addIngredientToRecipe() {
    const usageUnitSelect = document.querySelector('#usageUnitSelect');
    const quantityInput = document.querySelector('#quantityInput');
    
    const quantity = parseFloat(quantityInput.value);
    if (!quantity || quantity <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    const selectedOption = usageUnitSelect.selectedOptions[0];
    const usageUnitId = parseInt(selectedOption.value);
    const usageUnitName = selectedOption.text.split(' (')[0]; // Remove price part
    const price = parseFloat(selectedOption.dataset.price);
    
    // Add to selected ingredients
    selectedIngredients.push({
        ingredient_id: ingredient.id,
        ingredient_name: ingredient.name,
        usage_unit_id: usageUnitId,
        usage_unit_name: usageUnitName,
        quantity: quantity,
        estimated_cost: quantity * price
    });
    
    // Update display
    updateSelectedIngredientsDisplay();
    
    // Close modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
}

function updateSelectedIngredientsDisplay() {
    const container = document.getElementById('selectedIngredients');
    
    if (selectedIngredients.length === 0) {
        container.innerHTML = '<p class="text-muted">No ingredients added yet.</p>';
        return;
    }
    
    let html = '<h6>Selected Ingredients:</h6>';
    let totalCost = 0;
    
    selectedIngredients.forEach((ingredient, index) => {
        totalCost += ingredient.estimated_cost;
        html += `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${ingredient.ingredient_name}</strong><br>
                            <small>${ingredient.quantity} ${ingredient.usage_unit_name} - $${ingredient.estimated_cost.toFixed(2)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeIngredient(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `<div class="alert alert-info"><strong>Estimated Total Cost: $${totalCost.toFixed(2)}</strong></div>`;
    container.innerHTML = html;
}

function removeIngredient(index) {
    selectedIngredients.splice(index, 1);
    updateSelectedIngredientsDisplay();
}
</script>
{% endblock %}