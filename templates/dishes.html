{% extends "base.html" %}

{% block title %}Dishes - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-plate-wheat"></i> Dishes / Menu Items</h1>
    </div>
</div>

<div class="row mt-3">
    {% if current_user.role in ["admin", "manager"] %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Create New Dish</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/dishes/new" id="dishForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Dish Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <div class="input-group">
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">Select Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.icon or 'üîò' }} {{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="sale_price" class="form-label">Sale Price</label>
                        <input type="number" class="form-control" id="sale_price" name="sale_price" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>
                    
                    <h6>Batch Portions:</h6>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="batchSearch" 
                                   placeholder="Search for batches..." autocomplete="off">
                            <button type="button" class="btn btn-outline-secondary" id="addBatchBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="batchSuggestions" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="selectedBatches" class="mb-3">
                        <!-- Selected batches will appear here -->
                    </div>
                    
                    <input type="hidden" name="batch_portions_data" id="batchPortionsData">
                    
                    <h6>Ingredient Portions:</h6>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="ingredientSearch" 
                                   placeholder="Search for ingredients..." autocomplete="off">
                            <button type="button" class="btn btn-outline-secondary" id="addIngredientBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="ingredientSuggestions" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="selectedIngredients" class="mb-3">
                        <!-- Selected ingredients will appear here -->
                    </div>
                    
                    <input type="hidden" name="ingredient_portions_data" id="ingredientPortionsData">
                    
                    <button type="submit" class="btn btn-success mt-3">
                        <i class="fas fa-plus"></i> Create Dish
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="{% if current_user.role in ['admin', 'manager'] %}col-md-6{% else %}col-12{% endif %}">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Dishes List</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sortable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Dish Name</th>
                                <th data-sortable data-sort-type="currency">Price</th>
                                <th data-sortable data-sort-type="text">Category</th>
                                <th data-sortable data-sort-type="text">Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dish in dishes %}
                            <tr>
                                <td>
                                    {% if dish.category %}
                                        {{ dish.category.icon or 'üîò' }}
                                    {% else %}
                                        üîò
                                    {% endif %}
                                    <strong>{{ dish.name }}</strong>
                                </td>
                                <td>
                                    <span class="text-success">${{ "%.2f"|format(dish.sale_price) }}</span>
                                </td>
                                <td>
                                    {{ dish.category.name if dish.category else '-' }}
                                </td>
                                <td>
                                    {% if dish.description %}
                                        <small>{{ dish.description }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/dishes/{{ dish.id }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    {% if current_user.role in ["admin", "manager"] %}
                                    <a href="/dishes/{{ dish.id }}/edit" class="btn btn-sm btn-warning">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    {% endif %}
                                    {% if current_user.role == "admin" %}
                                    <a href="/dishes/{{ dish.id }}/delete" class="btn btn-sm btn-danger" 
                                       onclick="return confirm('Are you sure?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/categories/new">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" name="name" required>
                        <input type="hidden" name="type" value="dish">
                    </div>
                    <div class="mb-3">
                        <label for="categoryIcon" class="form-label">Icon (Unicode Emoji)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="categoryIcon" name="icon" placeholder="üîò" maxlength="10" oninput="previewIcon()">
                            <span class="input-group-text" id="iconPreview">üîò</span>
                        </div>
                        <small class="text-muted">Enter a Unicode emoji (e.g., üç¥, ü•ó, üçî)</small>
                    </div>
                    <input type="hidden" name="color" value="#6c757d">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectedBatches = [];
let selectedIngredients = [];
let allIngredients = [];
let currentBatchData = null;
let currentIngredientData = null;

document.addEventListener('DOMContentLoaded', function() {
    const batchSearch = document.getElementById('batchSearch');
    const suggestions = document.getElementById('batchSuggestions');
    const ingredientSearch = document.getElementById('ingredientSearch');
    const ingredientSuggestions = document.getElementById('ingredientSuggestions');
    
    let searchTimeout;
    let ingredientSearchTimeout;
    
    // Load all ingredients for dropdown
    loadAllIngredients();
    
    // Search batches as user types
    batchSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length === 0) {
            loadAllBatches();
            return;
        }
        
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/ingredients/${ingredientId}/cost_per_unit/${encodeURIComponent(selectedUnit)}`)
                .then(response => response.json())
                .then(data => {
                    displayBatchSuggestions(data);
                })
                .catch(error => console.error('Error:', error));
        }, 300);
    });
    
    // Show all batches when field is focused
    batchSearch.addEventListener('focus', function() {
        loadAllBatches();
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#batchSearch') && !e.target.closest('#batchSuggestions')) {
            suggestions.style.display = 'none';
        }
    });
    
    // Form submission
    document.getElementById('dishForm').addEventListener('submit', function(e) {
        document.getElementById('batchPortionsData').value = JSON.stringify(selectedBatches);
        document.getElementById('ingredientPortionsData').value = JSON.stringify(selectedIngredients);
    });
    
    // Search ingredients as user types
    ingredientSearch.addEventListener('input', function() {
        clearTimeout(ingredientSearchTimeout);
        const query = this.value.trim();
        
        if (query.length === 0) {
            loadAllIngredients();
            return;
        }
        
        if (query.length < 2) {
            ingredientSuggestions.style.display = 'none';
            return;
        }
        
        ingredientSearchTimeout = setTimeout(() => {
            filterIngredients(query);
        }, 300);
    });
    
    // Show all ingredients when field is focused
    ingredientSearch.addEventListener('focus', function() {
        if (allIngredients.length > 0) {
            filterIngredients('');
        }
        ingredientSuggestions.style.display = 'block';
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#ingredientSearch') && !e.target.closest('#ingredientSuggestions')) {
            ingredientSuggestions.style.display = 'none';
        }
    });
});

function loadAllBatches() {
    fetch('/api/batches/all')
        .then(response => response.json())
        .then(data => {
            displayBatchSuggestions(data);
        })
        .catch(error => console.error('Error loading all batches:', error));
}

function displayBatchSuggestions(batches) {
    const suggestions = document.getElementById('batchSuggestions');
    
    if (batches.length === 0) {
        suggestions.style.display = 'none';
        return;
    }
    
    suggestions.innerHTML = '';
    batches.forEach(batch => {
        const item = document.createElement('a');
        item.className = 'dropdown-item';
        item.href = '#';
        item.innerHTML = `
            <strong>${batch.recipe_name}</strong><br>
            <small>Yield: ${batch.yield_amount} ${batch.yield_unit} - $${batch.cost_per_unit.toFixed(4)}/unit</small>
            ${batch.category ? `<br><small class="text-muted">${batch.category}</small>` : ''}
        `;
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            selectBatch(batch);
        });
        
        suggestions.appendChild(item);
    });
    
    suggestions.style.display = 'block';
}

function selectBatch(batch) {
    // Check if batch already selected
    if (selectedBatches.find(sb => sb.batch_id === batch.id)) {
        alert('This batch is already added to the dish.');
        return;
    }
    
    currentBatchData = batch;
    document.getElementById('batchSearch').value = batch.recipe_name;
    document.getElementById('batchSuggestions').style.display = 'none';
    
    // Show portion size selection
    showPortionSizeSelection(batch);
}

function showPortionSizeSelection(batch) {
    // First load available portion units for this batch
    console.log('Loading portion units for batch:', batch.id);
    fetch(`/api/batches/${batch.id}/portion_units`)
        .then(response => response.json())
        .then(units => {
            console.log('Loaded units:', units);
            showPortionModal(batch, units);
        })
        .catch(error => {
            console.error('Error loading portion units:', error);
            // Fallback to just yield unit
            showPortionModal(batch, [{id: batch.yield_unit_id, name: batch.yield_unit}]);
        });
}

function showPortionModal(batch, availableUnits) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ${batch.recipe_name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Batch Details</label>
                        <p class="text-muted">Yield: ${batch.yield_amount} ${batch.yield_unit}<br>
                        Cost per ${batch.yield_unit}: $${batch.cost_per_unit.toFixed(4)}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Portion Size</label>
                        <div class="row">
                            <div class="col-8">
                                <input type="number" class="form-control" id="portionSizeInput" step="0.01" min="0" required>
                            </div>
                            <div class="col-4">
                                <select class="form-select" id="portionUnitSelect">
                                    ${availableUnits.map(unit => 
                                        `<option value="${unit.name}">${unit.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <small class="text-muted">Enter portion size and select unit</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useRecipePortionInput" onchange="toggleRecipePortionFields()">
                            <label class="form-check-label" for="useRecipePortionInput">
                                Use recipe portion (for variable yield batches)
                            </label>
                        </div>
                        <small class="text-muted">Use percentage of recipe cost instead of fixed portion size</small>
                    </div>
                    <div id="recipePortionFields" style="display: none;">
                        <div class="mb-3">
                            <label for="recipePortionPercentInput" class="form-label">Recipe Portion Percentage</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="recipePortionPercentInput" 
                                       step="1" min="1" max="100" placeholder="25">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Enter whole number percentage (e.g., 25 = 25% of recipe, 3 = 3% of recipe, 100 = 100% of recipe)</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estimated cost: $<span id="estimatedPortionCost">0.00</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addBatchToDish()">Add Batch</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Update cost estimate when portion size changes
    const portionSizeInput = modal.querySelector('#portionSizeInput');
    const portionUnitSelect = modal.querySelector('#portionUnitSelect');
    const estimatedCost = modal.querySelector('#estimatedPortionCost');
    
    async function updatePortionCost() {
        const portionSize = parseFloat(portionSizeInput.value) || 0;
        const selectedUnit = portionUnitSelect.value;
        const useRecipePortion = document.querySelector('#useRecipePortionInput').checked;
        const recipePortionPercent = parseFloat(document.querySelector('#recipePortionPercentInput').value) || 0;
        
        if (useRecipePortion && recipePortionPercent > 0) {
            try {
                const response = await fetch(`/api/batches/${batch.id}/recipe_cost`);
                const data = await response.json();
                const cost = data.total_recipe_cost * (recipePortionPercent / 100);
                estimatedCost.textContent = cost.toFixed(2);
            } catch (error) {
                console.error('Error calculating recipe cost:', error);
                estimatedCost.textContent = '0.00';
            }
        } else if (!useRecipePortion && portionSize > 0 && selectedUnit) {
            try {
                const response = await fetch(`/api/batches/${batch.id}/cost_per_unit/${encodeURIComponent(selectedUnit)}`);
                const data = await response.json();
                const cost = portionSize * data.expected_cost_per_unit;
                estimatedCost.textContent = cost.toFixed(2);
            } catch (error) {
                console.error('Error calculating cost:', error);
                estimatedCost.textContent = '0.00';
            }
        } else {
            estimatedCost.textContent = '0.00';
        }
    }
    
    portionSizeInput.addEventListener('input', updatePortionCost);
    portionUnitSelect.addEventListener('change', updatePortionCost);
    
    // Add event listeners for recipe portion fields
    const useRecipePortionInput = modal.querySelector('#useRecipePortionInput');
    const recipePortionPercentInput = modal.querySelector('#recipePortionPercentInput');
    
    if (useRecipePortionInput) {
        useRecipePortionInput.addEventListener('change', updatePortionCost);
    }
    if (recipePortionPercentInput) {
        recipePortionPercentInput.addEventListener('input', updatePortionCost);
    }
    
    // Initial cost calculation with slight delay to ensure DOM is ready
    setTimeout(updatePortionCost, 100);
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addBatchToDish() {
    const portionSizeInput = document.querySelector('#portionSizeInput');
    const portionUnitSelect = document.querySelector('#portionUnitSelect');
    const useRecipePortionInput = document.querySelector('#useRecipePortionInput');
    const recipePortionPercentInput = document.querySelector('#recipePortionPercentInput');
    
    const portionSize = parseFloat(portionSizeInput.value);
    const portionUnit = portionUnitSelect.value;
    const portionUnitName = portionUnitSelect.selectedOptions[0].text;
    const useRecipePortion = useRecipePortionInput.checked;
    const recipePortionPercent = parseFloat(recipePortionPercentInput.value);
    
    if (useRecipePortion) {
        if (!recipePortionPercent || recipePortionPercent <= 0 || recipePortionPercent > 100) {
            alert('Please enter a valid recipe portion percentage (0.1 - 100%).');
            return;
        }
    } else {
        if (!portionSize || portionSize <= 0) {
            alert('Please enter a valid portion size.');
            return;
        }
        
        if (!portionUnit) {
            alert('Please select a portion unit.');
            return;
        }
    }
    
    const estimatedCost = parseFloat(document.querySelector('#estimatedPortionCost').textContent);
    
    // Add to selected batches
    const batchData = {
        batch_id: currentBatchData.id,
        recipe_name: currentBatchData.recipe_name,
        estimated_cost: estimatedCost,
        use_recipe_portion: useRecipePortion
    };
    
    if (useRecipePortion) {
        batchData.recipe_portion_percent = recipePortionPercent / 100; // Convert to decimal
        batchData.portion_size = null;
        batchData.unit = null;
        batchData.portion_unit_name = 'recipe %';
    } else {
        batchData.unit = portionUnit;
        batchData.portion_unit_name = portionUnit;
        batchData.portion_size = portionSize;
        batchData.recipe_portion_percent = null;
    }
    
    selectedBatches.push(batchData);
    
    // Update display
    updateSelectedBatchesDisplay();
    
    // Clear search
    document.getElementById('batchSearch').value = '';
    
    // Close modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
}

function updateSelectedBatchesDisplay() {
    const container = document.getElementById('selectedBatches');
    
    if (selectedBatches.length === 0) {
        container.innerHTML = '<p class="text-muted">No batches added yet.</p>';
        return;
    }
    
    let html = '<h6>Selected Batches:</h6>';
    let totalCost = 0;
    
    selectedBatches.forEach((batch, index) => {
        totalCost += batch.estimated_cost;
        html += `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${batch.recipe_name}</strong><br>
                            <small>
                                ${batch.use_recipe_portion ? 
                                    `${(batch.recipe_portion_percent * 100).toFixed(1)}% of recipe` : 
                                    `${batch.portion_size} ${batch.portion_unit_name}`
                                } - $${batch.estimated_cost.toFixed(2)}
                            </small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeBatch(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `<div class="alert alert-info"><strong>Estimated Total Cost: $${totalCost.toFixed(2)}</strong></div>`;
    container.innerHTML = html;
}

function removeBatch(index) {
    selectedBatches.splice(index, 1);
    updateSelectedBatchesDisplay();
}

async function loadAllIngredients() {
    try {
        const response = await fetch('/api/ingredients/all');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        allIngredients = await response.json();
        console.log('Loaded ingredients:', allIngredients.length);
        // Don't show dropdown on page load - wait for user interaction
    } catch (error) {
        console.error('Error loading ingredients:', error);
        // Don't show error dropdown on page load either
    }
}

function filterIngredients(query) {
    const suggestions = document.getElementById('ingredientSuggestions');
    
    if (!allIngredients || allIngredients.length === 0) {
        suggestions.innerHTML = '<div class="dropdown-item-text text-muted">No ingredients available</div>';
        suggestions.style.display = 'block';
        return;
    }
    
    const filteredIngredients = allIngredients.filter(ingredient => 
        ingredient.name.toLowerCase().includes(query.toLowerCase()) ||
        (ingredient.category && ingredient.category.toLowerCase().includes(query.toLowerCase()))
    );
    
    suggestions.innerHTML = '';
    
    if (filteredIngredients.length === 0) {
        suggestions.innerHTML = '<div class="dropdown-item-text text-muted">No ingredients found</div>';
    } else {
        filteredIngredients.forEach(ingredient => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `
                <strong>${ingredient.name}</strong><br>
                <small>Available units: ${ingredient.available_units.join(', ')}</small>
                ${ingredient.category ? `<br><small class="text-muted">${ingredient.category}</small>` : ''}
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectIngredient(ingredient);
            });
            
            suggestions.appendChild(item);
        });
    }
    
    suggestions.style.display = 'block';
}

function selectIngredient(ingredient) {
    // Check if ingredient already selected
    if (selectedIngredients.find(si => si.ingredient_id === ingredient.id)) {
        alert('This ingredient is already added to the dish.');
        return;
    }
    
    currentIngredientData = ingredient;
    document.getElementById('ingredientSearch').value = ingredient.name;
    document.getElementById('ingredientSuggestions').style.display = 'none';
    
    // Show unit and quantity selection
    showIngredientPortionSelection(ingredient);
}

function showIngredientPortionSelection(ingredient) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ${ingredient.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ingredient Details</label>
                        <p class="text-muted">Available units: ${ingredient.available_units.join(', ')}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <div class="row">
                            <div class="col-8">
                                <input type="number" class="form-control" id="ingredientQuantityInput" step="0.01" min="0" required>
                            </div>
                            <div class="col-4">
                                <select class="form-select" id="ingredientUnitSelect">
                                    ${ingredient.available_units.map(unit => 
                                        `<option value="${unit}">${unit}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <small class="text-muted">Enter quantity and select unit</small>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estimated cost: $<span id="estimatedIngredientCost">0.00</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addIngredientToDish()">Add Ingredient</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Update cost estimate when quantity or unit changes
    const quantityInput = modal.querySelector('#ingredientQuantityInput');
    const unitSelect = modal.querySelector('#ingredientUnitSelect');
    const estimatedCost = modal.querySelector('#estimatedIngredientCost');
    
    async function updateIngredientCost() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const selectedUnit = unitSelect.value;
        
        if (quantity > 0 && selectedUnit) {
            try {
                const response = await fetch(`/api/ingredients/${ingredient.id}/cost_per_unit/${encodeURIComponent(selectedUnit)}`);
                const data = await response.json();
                const cost = quantity * data.cost_per_unit;
                estimatedCost.textContent = cost.toFixed(2);
            } catch (error) {
                console.error('Error calculating cost:', error);
                estimatedCost.textContent = '0.00';
            }
        } else {
            estimatedCost.textContent = '0.00';
        }
    }
    
    quantityInput.addEventListener('input', updateIngredientCost);
    unitSelect.addEventListener('change', updateIngredientCost);
    
    // Initial cost calculation
    setTimeout(updateIngredientCost, 100);
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addIngredientToDish() {
    const quantityInput = document.querySelector('#ingredientQuantityInput');
    const unitSelect = document.querySelector('#ingredientUnitSelect');
    
    const quantity = parseFloat(quantityInput.value);
    const unit = unitSelect.value;
    
    if (!quantity || quantity <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    if (!unit) {
        alert('Please select a unit.');
        return;
    }
    
    const estimatedCost = parseFloat(document.querySelector('#estimatedIngredientCost').textContent);
    
    // Add to selected ingredients
    selectedIngredients.push({
        ingredient_id: currentIngredientData.id,
        ingredient_name: currentIngredientData.name,
        quantity: quantity,
        unit: unit,
        estimated_cost: estimatedCost
    });
    
    // Update display
    updateSelectedIngredientsDisplay();
    
    // Clear search
    document.getElementById('ingredientSearch').value = '';
    
    // Close modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
}

function updateSelectedIngredientsDisplay() {
    const container = document.getElementById('selectedIngredients');
    
    if (selectedIngredients.length === 0) {
        container.innerHTML = '<p class="text-muted">No ingredients added yet.</p>';
        return;
    }
    
    let html = '<h6>Selected Ingredients:</h6>';
    let totalCost = 0;
    
    selectedIngredients.forEach((ingredient, index) => {
        totalCost += ingredient.estimated_cost;
        html += `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${ingredient.ingredient_name}</strong><br>
                            <small>${ingredient.quantity} ${ingredient.unit} - $${ingredient.estimated_cost.toFixed(2)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeIngredient(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `<div class="alert alert-secondary"><strong>Ingredient Cost Total: $${totalCost.toFixed(2)}</strong></div>`;
    container.innerHTML = html;
}

function removeIngredient(index) {
    selectedIngredients.splice(index, 1);
    updateSelectedIngredientsDisplay();
}

function toggleRecipePortionFields() {
    const useRecipePortionInput = document.querySelector('#useRecipePortionInput');
    const recipePortionFields = document.querySelector('#recipePortionFields');
    const portionSizeInput = document.querySelector('#portionSizeInput');
    const portionUnitSelect = document.querySelector('#portionUnitSelect');
    const recipePortionPercentInput = document.querySelector('#recipePortionPercentInput');
    
    if (useRecipePortionInput.checked) {
        recipePortionFields.style.display = 'block';
        portionSizeInput.required = false;
        portionUnitSelect.required = false;
        recipePortionPercentInput.required = true;
    } else {
        recipePortionFields.style.display = 'none';
        portionSizeInput.required = true;
        portionUnitSelect.required = true;
        recipePortionPercentInput.required = false;
    }
}

</script>
{% endblock %}