{% extends "base.html" %}

{% block title %}Inventory Day {{ inventory_day.date }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar-day"></i> Inventory Day: {{ inventory_day.date }}</h1>
        <a href="/inventory" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Inventory
        </a>
        
        {% if inventory_day.finalized %}
        <span class="badge bg-success ms-2">Finalized</span>
        {% else %}
        <span class="badge bg-warning ms-2">In Progress</span>
        {% endif %}
    </div>
</div>

{% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
<div class="row mb-3">
    <div class="col-12">
        <form method="post" action="/inventory/day/{{ inventory_day.id }}/update" class="d-inline">
            <input type="hidden" name="global_notes" value="{{ inventory_day.global_notes or '' }}">
            <button type="submit" name="force_regenerate" value="true" class="btn btn-warning me-2" 
                    onclick="return confirm('This will regenerate all auto-generated tasks. Continue?')">
                <i class="fas fa-sync"></i> Regenerate Tasks
            </button>
        </form>
        
        <form method="post" action="/inventory/day/{{ inventory_day.id }}/finalize" class="d-inline">
            <button type="submit" class="btn btn-success" 
                    onclick="return confirm('Finalize this day? This cannot be undone.')">
                <i class="fas fa-lock"></i> Finalize Day
            </button>
        </form>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Daily Inventory</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/update">
                    <div class="mb-3">
                        <label for="global_notes" class="form-label">Day Notes</label>
                        <textarea class="form-control" id="global_notes" name="global_notes" rows="2">{{ inventory_day.global_notes or '' }}</textarea>
                    </div>
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-striped table-sm table-sortable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Item</th>
                                <th data-sortable data-sort-type="number">Quantity</th>
                                <th data-sortable data-sort-type="number">Par Level</th>
                                <th data-sortable data-sort-type="text">Status</th>
                                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                <th>Override</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_item in inventory_day_items %}
                            {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                            {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                            {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                            {% set is_good = day_item.quantity >= day_item.inventory_item.par_level + 2 %}
                            <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                <td>
                                    <strong>{{ day_item.inventory_item.name }}</strong>
                                    {% if day_item.inventory_item.batch %}
                                    <br><small class="text-info">
                                        <i class="fas fa-link"></i> {{ day_item.inventory_item.batch.recipe.name }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                    <input type="number" class="form-control form-control-sm" 
                                           name="item_{{ day_item.inventory_item_id }}" 
                                           value="{{ day_item.quantity }}" step="0.1" style="width: 80px;">
                                    {% else %}
                                    {{ day_item.quantity }}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ day_item.inventory_item.par_level }}
                                    {% if day_item.inventory_item.par_unit_name %}
                                    <br><small class="text-muted">{{ day_item.inventory_item.par_unit_name.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if is_below_par %}
                                        <span class="badge bg-danger">Below Par</span>
                                    {% elif is_on_par %}
                                        <span class="badge bg-info">On Par</span>
                                    {% elif is_near_par %}
                                        <span class="badge bg-warning">Near Par</span>
                                    {% else %}
                                        <span class="badge bg-success">Good</span>
                                    {% endif %}
                                </td>
                                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                <td>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" 
                                               name="override_create_{{ day_item.inventory_item_id }}" 
                                               {% if day_item.override_create_task %}checked{% endif %}>
                                        <label class="form-check-label">
                                            <small>Force Task</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" 
                                               name="override_no_task_{{ day_item.inventory_item_id }}" 
                                               {% if day_item.override_no_task %}checked{% endif %}>
                                        <label class="form-check-label">
                                            <small>No Task</small>
                                        </label>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if janitorial_day_items %}
                <h6 class="mt-4">Janitorial Tasks</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-sm table-sortable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Task</th>
                                <th data-sortable data-sort-type="text">Type</th>
                                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                <th>Include</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for janitorial_day_item in janitorial_day_items %}
                            <tr>
                                <td>
                                    <strong>{{ janitorial_day_item.janitorial_task.title }}</strong>
                                    {% if janitorial_day_item.janitorial_task.instructions %}
                                    <br><small class="text-muted">{{ janitorial_day_item.janitorial_task.instructions[:30] }}{% if janitorial_day_item.janitorial_task.instructions|length > 30 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}
                                        <span class="badge bg-primary">Daily</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Manual</span>
                                    {% endif %}
                                </td>
                                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                <td>
                                    {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}
                                        <span class="text-muted">Auto-included</span>
                                    {% else %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="janitorial_{{ janitorial_day_item.janitorial_task_id }}" 
                                                   {% if janitorial_day_item.include_task %}checked{% endif %}>
                                            <label class="form-check-label">Include</label>
                                        </div>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                    <button type="submit" class="btn btn-primary mt-3">
                        <i class="fas fa-save"></i> Update Inventory & Generate Tasks
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Tasks</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                <div class="mb-3">
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="fas fa-plus"></i> Add Manual Task
                    </button>
                </div>
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-striped table-sm table-sortable" id="tasksTable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Task</th>
                                <th data-sortable data-sort-type="text">Assigned To</th>
                                <th data-sortable data-sort-type="text">Status</th>
                                <th data-sortable data-sort-type="number">Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            {% for task in tasks %}
                            <tr data-task-id="{{ task.id }}">
                                <td>
                                    <small>{{ task.description }}</small>
                                   {% if task.inventory_item and task.inventory_item.category %}
                                       {{ task.inventory_item.category.icon or 'ðŸ”˜' }}
                                   {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                       {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }}
                                   {% elif task.janitorial_task_id %}
                                       ðŸ§¹
                                   {% elif task.batch and task.batch.category %}
                                       {{ task.batch.category.icon or 'ðŸ”˜' }}
                                   {% elif task.category %}
                                       {{ task.category.icon or 'ðŸ”˜' }}
                                   {% else %}
                                       ðŸ”˜
                                   {% endif %}
                                    {% if task.batch %}
                                        <br><small class="text-info">{{ task.batch.recipe.name }}
                                            {% if task.selected_scale and task.selected_scale != 'full' %}
                                            ({{ task.selected_scale }})
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                    {% if task.made_amount %}
                                        <br><small class="text-success">
                                        <i class="fas fa-check"></i> Made: {{ task.made_amount }} {{ task.made_unit }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td class="assigned-employee-cell">
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <small class="text-info">Team of {{ employee_ids|length }}</small>
                                            <br>
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        <small class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        <small>{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        <small>{{ task.assigned_to.full_name or task.assigned_to.username }}</small>
                                    {% else %}
                                        <small class="text-warning">Unassigned</small>
                                    {% endif %}
                                </td>
                                <td class="task-status-cell">
                                    {% if task.status == "not_started" %}
                                        {% if task.requires_scale_selection %}
                                        <button type="button" class="btn btn-primary btn-sm" onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                            <i class="fas fa-play"></i> Select Scale & Start
                                        </button>
                                        {% elif not inventory_day.finalized and current_user.role in ["admin", "manager", "user"] %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display: inline;">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-play"></i> Start
                                            </button>
                                        </form>
                                        {% else %}
                                        <span class="badge bg-secondary">Not Started</span>
                                        {% endif %}
                                    {% elif task.status == "in_progress" %}
                                        {% if not inventory_day.finalized and current_user.role in ["admin", "manager", "user"] %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause" style="display: inline;">
                                            <button type="submit" class="btn btn-warning btn-sm">
                                                <i class="fas fa-pause"></i> Pause
                                            </button>
                                        </form>
                                        {% if task.requires_made_amount %}
                                        <button type="button" class="btn btn-success btn-sm" onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                            <i class="fas fa-check"></i> Finish & Enter Amount
                                        </button>
                                        {% else %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display: inline;">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Finish
                                            </button>
                                        </form>
                                        {% endif %}
                                        {% else %}
                                        <span class="badge bg-primary">In Progress</span>
                                        {% endif %}
                                    {% elif task.status == "paused" %}
                                        {% if task.requires_made_amount %}
                                        <button type="button" class="btn btn-success btn-sm" onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                            <i class="fas fa-check"></i> Finish & Enter Amount
                                        </button>
                                        {% elif not inventory_day.finalized and current_user.role in ["admin", "manager", "user"] %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume" style="display: inline;">
                                            <button type="submit" class="btn btn-info btn-sm">
                                                <i class="fas fa-play"></i> Resume
                                            </button>
                                        </form>
                                        {% else %}
                                        <span class="badge bg-warning">Paused</span>
                                        {% endif %}
                                    {% elif task.status == "completed" %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </td>
                                <td class="time-cell">
                                    {% if task.started_at %}
                                        <small>{{ task.total_time_minutes }} min</small>
                                        {% if task.finished_at and task.assigned_employees|length > 0 %}
                                        <br><small class="text-success">${{ "%.2f"|format(task.labor_cost) }}</small>
                                        {% endif %}
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td class="task-actions-cell">
                                    <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showAssignModal({{ task.id }})">
                                        <i class="fas fa-users"></i> Assign
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Day Summary</h5>
            </div>
            <div class="card-body">
                {% if inventory_day.employees_working %}
                <p><strong>Employees Working:</strong></p>
                {% set employee_ids = inventory_day.employees_working.split(',') %}
                <div class="d-flex flex-wrap gap-1 mb-3">
                    {% for emp_id in employee_ids %}
                        {% for emp in employees %}
                            {% if emp.id|string == emp_id %}
                            <span class="badge bg-secondary">{{ emp.full_name or emp.username }}</span>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}
                
                {% set total_tasks = tasks|length %}
                {% set completed_tasks = 0 %}
                {% set in_progress_tasks = 0 %}
                {% set below_par_count = 0 %}
                
                {% for task in tasks %}
                    {% if task.status == 'completed' %}
                        {% set completed_tasks = completed_tasks + 1 %}
                    {% elif task.status == 'in_progress' %}
                        {% set in_progress_tasks = in_progress_tasks + 1 %}
                    {% endif %}
                {% endfor %}
                
                {% for day_item in inventory_day_items %}
                    {% if day_item.quantity < day_item.inventory_item.par_level %}
                        {% set below_par_count = below_par_count + 1 %}
                    {% endif %}
                {% endfor %}
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body p-2">
                                <h5>{{ total_tasks }}</h5>
                                <small>Total Tasks</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white">
                            <div class="card-body p-2">
                                <h5>{{ completed_tasks }}</h5>
                                <small>Completed</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <div class="card bg-warning text-white">
                            <div class="card-body p-2">
                                <h5>{{ in_progress_tasks }}</h5>
                                <small>In Progress</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-danger text-white">
                            <div class="card-body p-2">
                                <h5>{{ below_par_count }}</h5>
                                <small>Below Par</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% set total_time = 0 %}
                {% set total_cost = 0 %}
                {% for task in tasks %}
                    {% if task.finished_at %}
                        {% set total_time = total_time + task.total_time_minutes %}
                        {% set total_cost = total_cost + task.labor_cost %}
                    {% endif %}
                {% endfor %}
                
                {% if completed_tasks > 0 %}
                <div class="mt-3">
                    <p><strong>Total Time:</strong> {{ total_time }} minutes ({{ "%.1f"|format(total_time / 60) }} hours)</p>
                    <p><strong>Total Labor Cost:</strong> ${{ "%.2f"|format(total_cost) }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if task_summaries %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-clipboard-check"></i> Completed Task Summaries</h5>
            </div>
            <div class="card-body">
                {% for task_id, summary in task_summaries.items() %}
                {% set task = tasks|selectattr('id', 'equalto', task_id)|first %}
                {% if task %}
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">{{ task.description }}</h6>
                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <strong>Initial:</strong> {{ "%.1f"|format(summary.initial_inventory) }} {{ summary.par_unit_name }}<br>
                                    <strong>Made:</strong> {{ summary.made_amount or 0 }} {{ summary.made_unit or summary.par_unit_name }}<br>
                                    <strong>Final:</strong> {{ "%.1f"|format(summary.final_inventory) }} {{ summary.par_unit_name }}
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <strong>Time:</strong> {{ task.total_time_minutes }} min<br>
                                    <strong>Cost:</strong> ${{ "%.2f"|format(task.labor_cost) }}<br>
                                    <strong>Wage:</strong> ${{ "%.2f"|format(task.highest_hourly_wage) }}/hr
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Manual Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/new">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Assign to Employees:</label>
                        {% for emp in employees %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="modal_emp_{{ emp.id }}">
                            <label class="form-check-label" for="modal_emp_{{ emp.id }}">
                               {{ emp.full_name or emp.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_inventory_item_id" class="form-label">Link to Inventory Item (Optional)</label>
                        <select class="form-select" id="modal_inventory_item_id" name="inventory_item_id">
                            <option value="">No item linked</option>
                            {% for day_item in inventory_day_items %}
                            <option value="{{ day_item.inventory_item.id }}">{{ day_item.inventory_item.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Link to inventory item for par level tracking</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_batch_id" class="form-label">Link to Batch (Optional)</label>
                        <select class="form-select" id="modal_batch_id" name="batch_id">
                            <option value="">No batch linked</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}">{{ batch.recipe.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Link to batch for labor cost tracking</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_category_id" class="form-label">Category (For Manual Tasks)</label>
                        <select class="form-select" id="modal_category_id" name="category_id">
                            <option value="">No category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.icon or 'ðŸ”˜' }} {{ cat.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Select category for manual tasks (affects task icon)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_description" class="form-label">Task Description</label>
                        <input type="text" class="form-control" id="modal_description" name="description" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assignment Modal (will be created dynamically) -->
<div id="assignModalContainer"></div>

<script>
// SSE Connection and Real-time Updates
let eventSource = null;
let isConnected = false;

function connectSSE() {
    const dayId = {{ inventory_day.id }};
    console.log('Connecting to SSE for day:', dayId);
    
    eventSource = new EventSource(`/events/inventory/${dayId}`);
    
    eventSource.onopen = function(event) {
        console.log('SSE connection opened');
        isConnected = true;
        showNotification('Connected to real-time updates', 'success');
    };
    
    eventSource.onmessage = function(event) {
        console.log('SSE message received:', event.data);
        try {
            const data = JSON.parse(event.data);
            handleSSEEvent(data);
        } catch (error) {
            console.error('Error parsing SSE message:', error);
        }
    };
    
    eventSource.onerror = function(event) {
        console.error('SSE connection error:', event);
        isConnected = false;
        showNotification('Connection lost - attempting to reconnect...', 'warning');
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            if (eventSource.readyState === EventSource.CLOSED) {
                console.log('Attempting to reconnect SSE...');
                connectSSE();
            }
        }, 5000);
    };
    
    // Handle specific event types
    eventSource.addEventListener('connected', function(event) {
        console.log('SSE connected event received');
        showNotification('Connected to real-time updates', 'success');
    });
    
    // Add debugging for all SSE events
    eventSource.addEventListener('message', function(event) {
        console.log('Raw SSE message received:', event.data);
    });
    
    eventSource.addEventListener('task_assigned', function(event) {
        console.log('Task assigned event received:', event.data);
        const data = JSON.parse(event.data);
        updateTaskAssignment(data.task_id, data.assigned_employees, data.primary_assignee);
        showNotification(`Task assigned to ${data.assigned_employees.join(', ')}`, 'info');
    });
    
    eventSource.addEventListener('task_started', function(event) {
        console.log('Task started event received:', event.data);
        const data = JSON.parse(event.data);
        updateTaskStatus(data.task_id, 'in_progress', data.started_at);
        showNotification(`Task started by ${data.started_by}`, 'info');
    });
    
    eventSource.addEventListener('task_paused', function(event) {
        console.log('Task paused event received:', event.data);
        const data = JSON.parse(event.data);
        updateTaskStatus(data.task_id, 'paused', null, data.paused_at);
        showNotification(`Task paused by ${data.paused_by}`, 'warning');
    });
    
    eventSource.addEventListener('task_resumed', function(event) {
        console.log('Task resumed event received:', event.data);
        const data = JSON.parse(event.data);
        updateTaskStatus(data.task_id, 'in_progress', data.resumed_at);
        showNotification(`Task resumed by ${data.resumed_by}`, 'info');
    });
    
    eventSource.addEventListener('task_completed', function(event) {
        console.log('Task completed event received:', event.data);
        const data = JSON.parse(event.data);
        updateTaskStatus(data.task_id, 'completed', null, null, data.finished_at);
        showNotification(`Task completed by ${data.completed_by}`, 'success');
    });

    eventSource.addEventListener('tasks_generated', function(event) {
        console.log('Tasks generated event received:', event.data);
        const data = JSON.parse(event.data);
        if (data.force_regenerate) {
            // Reload page for force regenerate
            showNotification('Tasks regenerated - reloading page...', 'info');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            // Add new tasks to table
            addNewTasksToTable(data.tasks);
            showNotification(`${data.tasks.length} new tasks generated`, 'success');
        }
    });

    eventSource.addEventListener('inventory_batch_updated', function(event) {
        console.log('Inventory batch updated event received:', event.data);
        const data = JSON.parse(event.data);
        updateInventoryQuantities(data.items);
        showNotification('Inventory updated by another user', 'info');
    });
    
    eventSource.addEventListener('heartbeat', function(event) {
        console.log('SSE heartbeat received');
    });

    eventSource.addEventListener('error', function(event) {
        console.error('SSE connection error:', event);
        showNotification('Connection error - some updates may be delayed', 'danger');
    });
}

function handleSSEEvent(data) {
    console.log('Handling SSE event:', data.type, data);
    
    switch(data.type) {
        case 'connected':
            console.log('SSE connection confirmed for day:', data.day_id);
            break;
        case 'heartbeat':
            console.log('SSE heartbeat received');
            break;
        case 'tasks_generated':
            handleTasksGenerated(data);
            break;
        case 'task_assigned':
            handleTaskAssigned(data);
            break;
        case 'task_started':
            handleTaskStarted(data);
            break;
        case 'task_paused':
            handleTaskPaused(data);
            break;
        case 'task_completed':
            handleTaskCompleted(data);
            break;
        case 'inventory_updated':
            handleInventoryUpdated(data);
            break;
        default:
            console.log('Unknown SSE event type:', data.type);
    }
}

function handleTasksGenerated(data) {
    console.log('Handling tasks generated:', data);
    showNotification(`${data.tasks.length} new tasks generated`, 'info');
    
    // Reload the page to show new tasks
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function handleTaskAssigned(data) {
    console.log('Handling task assigned:', data);
    const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
    if (taskRow) {
        const assignedCell = taskRow.querySelector('.assigned-to-cell');
        if (assignedCell && data.assigned_employees) {
            if (data.assigned_employees.length > 1) {
                assignedCell.innerHTML = `
                    <small class="text-info">Team of ${data.assigned_employees.length}</small><br>
                    ${data.assigned_employees.map(emp => `<small class="badge bg-secondary me-1">${emp}</small>`).join('')}
                `;
            } else {
                assignedCell.innerHTML = `<small>${data.assigned_employees[0]}</small>`;
            }
        }
    }
    showNotification(`Task assigned to ${data.assigned_employees.join(', ')}`, 'info');
}

function handleTaskStarted(data) {
    console.log('Handling task started:', data);
    const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
    if (taskRow) {
        const statusCell = taskRow.querySelector('.status-cell');
        if (statusCell) {
            statusCell.innerHTML = `
                <span class="badge bg-primary">In Progress</span>
                <br><small class="text-muted">Started: ${new Date(data.started_at).toLocaleTimeString()}</small>
            `;
        }
    }
    showNotification(`Task started: ${data.description}`, 'success');
}

function handleTaskPaused(data) {
    console.log('Handling task paused:', data);
    const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
    if (taskRow) {
        const statusCell = taskRow.querySelector('.status-cell');
        if (statusCell) {
            statusCell.innerHTML = `
                <span class="badge bg-warning">Paused</span>
                <br><small class="text-muted">Time: ${data.total_time} min</small>
            `;
        }
    }
    showNotification(`Task paused: ${data.description}`, 'warning');
}

function handleTaskCompleted(data) {
    console.log('Handling task completed:', data);
    const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
    if (taskRow) {
        const statusCell = taskRow.querySelector('.status-cell');
        const timeCell = taskRow.querySelector('.time-cell');
        
        if (statusCell) {
            statusCell.innerHTML = `<span class="badge bg-success">Completed</span>`;
        }
        
        if (timeCell) {
            timeCell.innerHTML = `
                <small>${data.total_time} min</small>
                <br><small class="text-success">$${data.labor_cost.toFixed(2)}</small>
            `;
        }
    }
    showNotification(`Task completed: ${data.description}`, 'success');
}

function handleInventoryUpdated(data) {
    console.log('Handling inventory updated:', data);
    showNotification('Inventory quantities updated', 'info');
    
    // Update inventory quantities in the table
    data.items.forEach(item => {
        const input = document.querySelector(`input[name="item_${item.item_id}"]`);
        if (input) {
            input.value = item.quantity;
            
            // Update row styling based on par status
            const row = input.closest('tr');
            if (row) {
                row.className = '';
                if (item.status === 'below_par') {
                    row.classList.add('table-danger');
                } else if (item.status === 'on_par') {
                    row.classList.add('table-info');
                } else if (item.status === 'near_par') {
                    row.classList.add('table-warning');
                }
            }
        }
    });
}

// Function to update task assignment in the DOM
function updateTaskAssignment(taskId, assignedEmployees, primaryAssignee) {
    console.log(`Updating task ${taskId} assignment to:`, assignedEmployees);
    
    const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
    if (!taskRow) {
        console.warn(`Task row not found for task ID: ${taskId}`);
        return;
    }
    
    const assignedCell = taskRow.querySelector('.assigned-employee-cell');
    if (!assignedCell) {
        console.warn(`Assigned employee cell not found for task ID: ${taskId}`);
        return;
    }
    
    // Update the assigned employee display
    if (assignedEmployees && assignedEmployees.length > 0) {
        if (assignedEmployees.length === 1) {
            assignedCell.innerHTML = `<small>${assignedEmployees[0]}</small>`;
        } else {
            assignedCell.innerHTML = `
                <small class="text-info">Team of ${assignedEmployees.length}</small><br>
                ${assignedEmployees.map(emp => `<span class="badge bg-secondary me-1">${emp}</span>`).join('')}
            `;
        }
    } else {
        assignedCell.innerHTML = '<small class="text-warning">Unassigned</small>';
    }
    
    // Update action buttons - enable start button if task is assigned
    const actionCell = taskRow.querySelector('.task-actions-cell');
    if (actionCell && assignedEmployees && assignedEmployees.length > 0) {
        const startButton = actionCell.querySelector('button[onclick*="start"]');
        if (startButton) {
            startButton.disabled = false;
            startButton.classList.remove('btn-outline-success');
            startButton.classList.add('btn-success');
        }
    }
    
    console.log(`âœ… Updated task ${taskId} assignment display`);
}

// Function to update task status in the DOM
function updateTaskStatus(taskId, status, startedAt = null, pausedAt = null, finishedAt = null) {
    console.log(`Updating task ${taskId} status to: ${status}`);
    
    const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
    if (!taskRow) {
        console.warn(`Task row not found for task ID: ${taskId}`);
        return;
    }
    
    const statusCell = taskRow.querySelector('.task-status-cell');
    const actionCell = taskRow.querySelector('.task-actions-cell');
    
    if (!statusCell || !actionCell) {
        console.warn(`Status or action cell not found for task ID: ${taskId}`);
        return;
    }
    
    // Update status badge
    let statusBadge = '';
    switch (status) {
        case 'not_started':
            statusBadge = '<span class="badge bg-secondary">Not Started</span>';
            break;
        case 'in_progress':
            statusBadge = '<span class="badge bg-primary">In Progress</span>';
            if (startedAt) {
                statusBadge += `<br><small class="text-muted">Started: ${new Date(startedAt).toLocaleTimeString()}</small>`;
            }
            break;
        case 'paused':
            statusBadge = '<span class="badge bg-warning">Paused</span>';
            if (pausedAt) {
                statusBadge += `<br><small class="text-muted">Paused: ${new Date(pausedAt).toLocaleTimeString()}</small>`;
            }
            break;
        case 'completed':
            statusBadge = '<span class="badge bg-success">Completed</span>';
            if (finishedAt) {
                statusBadge += `<br><small class="text-muted">Finished: ${new Date(finishedAt).toLocaleTimeString()}</small>`;
            }
            break;
    }
    
    statusCell.innerHTML = statusBadge;
    
    // Update action buttons based on status
    let actionButtons = '';
    switch (status) {
        case 'not_started':
            actionButtons = `
                <button type="button" class="btn btn-sm btn-outline-success" onclick="startTask(${taskId})" disabled>
                    <i class="fas fa-play"></i> Start
                </button>
            `;
            break;
        case 'in_progress':
            actionButtons = `
                <button type="button" class="btn btn-sm btn-warning" onclick="pauseTask(${taskId})">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="finishTask(${taskId})">
                    <i class="fas fa-check"></i> Finish
                </button>
            `;
            break;
        case 'paused':
            actionButtons = `
                <button type="button" class="btn btn-sm btn-info" onclick="resumeTask(${taskId})">
                    <i class="fas fa-play"></i> Resume
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="finishTask(${taskId})">
                    <i class="fas fa-check"></i> Finish
                </button>
            `;
            break;
        case 'completed':
            actionButtons = '<span class="text-success"><i class="fas fa-check-circle"></i> Done</span>';
            break;
    }
    
    actionCell.innerHTML = actionButtons;
    
    console.log(`âœ… Updated task ${taskId} status display to: ${status}`);
}

// Function to add new tasks to the table
function addNewTasksToTable(tasks) {
    console.log('Adding new tasks to table:', tasks);
    const tasksTableBody = document.querySelector('#tasksTableBody');
    if (!tasksTableBody) {
        console.warn('Tasks table body not found');
        return;
    }
    
    tasks.forEach(task => {
        const row = document.createElement('tr');
        row.setAttribute('data-task-id', task.id);
        
        // Build task row HTML
        row.innerHTML = `
            <td>
                <small>${task.description}</small>
                ${task.icon ? task.icon : 'ðŸ”˜'}
                ${task.batch_info ? `<br><small class="text-info">${task.batch_info}</small>` : ''}
            </td>
            <td class="assigned-employee-cell">
                <small class="text-warning">Unassigned</small>
            </td>
            <td class="task-status-cell">
                <span class="badge bg-secondary">Not Started</span>
            </td>
            <td class="time-cell">
                <small class="text-muted">-</small>
            </td>
            <td class="task-actions-cell">
                <a href="/inventory/day/{{ inventory_day.id }}/tasks/${task.id}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showAssignModal(${task.id})">
                    <i class="fas fa-users"></i> Assign
                </button>
            </td>
        `;
        
        tasksTableBody.appendChild(row);
    });
}

// Function to update inventory quantities
function updateInventoryQuantities(items) {
    console.log('Updating inventory quantities:', items);
    items.forEach(item => {
        const input = document.querySelector(`input[name="item_${item.item_id}"]`);
        if (input) {
            input.value = item.quantity;
            
            // Update row styling based on par status
            const row = input.closest('tr');
            if (row) {
                row.className = '';
                if (item.status === 'below_par') {
                    row.classList.add('table-danger');
                } else if (item.status === 'on_par') {
                    row.classList.add('table-info');
                } else if (item.status === 'near_par') {
                    row.classList.add('table-warning');
                }
            }
        }
    });
}

// Helper functions for task actions
function startTask(taskId) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start`;
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

function pauseTask(taskId) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/pause`;
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

function resumeTask(taskId) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/resume`;
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

function finishTask(taskId) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish`;
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

// Show notification function
function showNotification(message, type = 'info') {
    console.log(`Showing notification: ${message} (${type})`);
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Connect to SSE when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, connecting to SSE...');
    connectSSE();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        console.log('Closing SSE connection...');
        eventSource.close();
    }
});

// Show assignment modal for existing tasks
function showAssignModal(taskId) {
    const modalContainer = document.getElementById('assignModalContainer');
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'assignModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Employees to Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/assign_multiple">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Employees:</label>
                            <small class="text-muted d-block mb-2">Labor cost will be calculated using the highest wage among selected employees.</small>
                            {% for emp in employees %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="assign_emp_{{ emp.id }}">
                                <label class="form-check-label" for="assign_emp_{{ emp.id }}">
                                   {{ emp.full_name or emp.username }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign Employees</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = '';
    modalContainer.appendChild(modal);
    
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        modalContainer.innerHTML = '';
    });
}

// Scale Selection Modal
function showScaleSelection(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/scale_options`)
        .then(response => response.json())
        .then(scales => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Batch Scale - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select batch scale to make:</label>
                                <select class="form-select" id="scaleSelect" required>
                                    <option value="">Choose scale...</option>
                                    ${scales.map(scale => 
                                        `<option value="${scale.key}" data-yield="${scale.yield}">${scale.label} - ${scale.yield}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="startTaskWithScale(${taskId})">Start Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading scale options:', error);
            alert('Error loading scale options');
        });
}

function startTaskWithScale(taskId) {
    const scaleSelect = document.getElementById('scaleSelect');
    const selectedScale = scaleSelect.value;
    
    if (!selectedScale) {
        alert('Please select a batch scale');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start_with_scale`;
    form.style.display = 'none';
    
    const scaleInput = document.createElement('input');
    scaleInput.name = 'selected_scale';
    scaleInput.value = selectedScale;
    
    form.appendChild(scaleInput);
    document.body.appendChild(form);
    form.submit();
}

// Made Amount Input Modal
function showMadeAmountInput(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/finish_requirements`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Amount Made - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${data.use_par_unit ? `
                            <div class="mb-3">
                                <label class="form-label">Amount Made (in ${data.par_unit_name}):</label>
                                <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                <input type="hidden" id="hiddenMadeUnit" value="${data.par_unit_name}">
                                ${data.par_unit_equals_info ? `
                                <small class="text-info">${data.par_unit_equals_info.description}</small>
                                ` : ''}
                            </div>
                            ` : `
                            <div class="mb-3">
                                <label class="form-label">Amount Made:</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-4" id="madeUnitSection" ${data.available_units.length === 1 ? 'style="display: none;"' : ''}>
                                        <select class="form-select" id="madeUnit" required>
                                            ${data.available_units.map(unit => 
                                                `<option value="${unit}">${unit}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                ${data.available_units.length === 1 ? `
                                <small class="text-info">Unit: ${data.available_units[0]}</small>
                                <input type="hidden" id="hiddenMadeUnit" value="${data.available_units[0]}">
                                ` : ''}
                            </div>
                            `}
                            ${data.inventory_info ? `
                            <div class="alert alert-info">
                                <small>
                                    <strong>Current Inventory:</strong> ${data.inventory_info.current} ${data.inventory_info.par_unit_name}<br>
                                    <strong>Par Level:</strong> ${data.inventory_info.par_level} ${data.inventory_info.par_unit_name}
                                </small>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="finishTaskWithAmount(${taskId})">Finish Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading finish requirements:', error);
            alert('Error loading task requirements');
        });
}

function finishTaskWithAmount(taskId) {
    const madeAmount = document.getElementById('madeAmount').value;
    const madeUnitInput = document.getElementById('madeUnit');
    const hiddenMadeUnit = document.getElementById('hiddenMadeUnit');
    
    const madeUnit = madeUnitInput ? madeUnitInput.value : hiddenMadeUnit.value;
    
    if (!madeAmount || !madeUnit) {
        alert('Please enter amount made and select unit');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish_with_amount`;
    form.style.display = 'none';
    
    const amountInput = document.createElement('input');
    amountInput.name = 'made_amount';
    amountInput.value = madeAmount;
    
    const unitInput = document.createElement('input');
    unitInput.name = 'made_unit';
    unitInput.value = madeUnit;
    
    form.appendChild(amountInput);
    form.appendChild(unitInput);
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}