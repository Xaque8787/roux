{% extends "base.html" %}

{% block title %}Inventory Day {{ inventory_day.date }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar-day"></i> Inventory Day: {{ inventory_day.date.strftime('%Y-%m-%d') }}</h1>
        <a href="/inventory" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Inventory
        </a>
    </div>
</div>

<div class="row mt-3">
    <!-- Left Side: Inventory Items -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Daily Inventory</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized %}
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/update" id="inventoryForm">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm table-sortable">
                            <thead>
                                <tr>
                                    <th data-sortable data-sort-type="text">Item</th>
                                    <th data-sortable data-sort-type="number">Quantity</th>
                                    <th data-sortable data-sort-type="number">Par</th>
                                    <th data-sortable data-sort-type="text">Status</th>
                                    <th>Force Task</th>
                                    <th>Skip Task</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_item in inventory_day_items %}
                                {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                                {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                                {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                                <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                    <td>
                                        {% if day_item.inventory_item.category %}
                                            {{ day_item.inventory_item.category.icon or 'üîò' }}
                                        {% else %}
                                            üîò
                                        {% endif %}
                                        <strong>{{ day_item.inventory_item.name }}</strong>
                                        {% if day_item.inventory_item.batch %}
                                        <br><small class="text-muted">{{ day_item.inventory_item.batch.recipe.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" style="width: 80px;" 
                                               name="item_{{ day_item.inventory_item_id }}" 
                                               value="{{ day_item.quantity }}" step="0.1" min="0">
                                    </td>
                                    <td>
                                        {{ day_item.inventory_item.par_level }}
                                        {% if day_item.inventory_item.par_unit_name %}
                                            {{ day_item.inventory_item.par_unit_name.name }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if is_below_par %}
                                            <span class="badge bg-danger">Below Par</span>
                                        {% elif is_on_par %}
                                            <span class="badge bg-info">On Par</span>
                                        {% elif is_near_par %}
                                            <span class="badge bg-warning">Near Par</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input" 
                                               name="override_create_{{ day_item.inventory_item_id }}"
                                               {% if day_item.override_create_task %}checked{% endif %}>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input" 
                                               name="override_no_task_{{ day_item.inventory_item_id }}"
                                               {% if day_item.override_no_task %}checked{% endif %}>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-3">Janitorial Tasks</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Type</th>
                                    <th>Include</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for janitorial_day_item in janitorial_day_items %}
                                <tr>
                                    <td>
                                        <strong>{{ janitorial_day_item.janitorial_task.title }}</strong>
                                        {% if janitorial_day_item.janitorial_task.instructions %}
                                        <br><small class="text-muted">{{ janitorial_day_item.janitorial_task.instructions[:50] }}...</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}
                                            <span class="badge bg-primary">Daily</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Manual</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}
                                            <i class="fas fa-check text-success"></i>
                                            <input type="hidden" name="janitorial_{{ janitorial_day_item.janitorial_task_id }}" value="on">
                                        {% else %}
                                            <input type="checkbox" class="form-check-input" 
                                                   name="janitorial_{{ janitorial_day_item.janitorial_task_id }}"
                                                   {% if janitorial_day_item.include_task %}checked{% endif %}>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-3">
                        <label for="global_notes" class="form-label">Day Notes</label>
                        <textarea class="form-control" id="global_notes" name="global_notes" rows="3">{{ inventory_day.global_notes or '' }}</textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync"></i> Update & Generate Tasks
                        </button>
                        <button type="submit" name="force_regenerate" value="true" class="btn btn-warning">
                            <i class="fas fa-redo"></i> Regenerate All Tasks
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Par Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_item in inventory_day_items %}
                            {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                            {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                            {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                            <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                <td>
                                    {% if day_item.inventory_item.category %}
                                        {{ day_item.inventory_item.category.icon or 'üîò' }}
                                    {% else %}
                                        üîò
                                    {% endif %}
                                    <strong>{{ day_item.inventory_item.name }}</strong>
                                </td>
                                <td>{{ day_item.quantity }}</td>
                                <td>{{ day_item.inventory_item.par_level }}</td>
                                <td>
                                    {% if is_below_par %}
                                        <span class="badge bg-danger">Below Par</span>
                                    {% elif is_on_par %}
                                        <span class="badge bg-info">On Par</span>
                                    {% elif is_near_par %}
                                        <span class="badge bg-warning">Near Par</span>
                                    {% else %}
                                        <span class="badge bg-success">Good</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Side: Generated Tasks -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-tasks"></i> Generated Tasks</h5>
                    {% if current_user.role in ["admin", "manager"] and not inventory_day.finalized %}
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#manualTaskModal">
                        <i class="fas fa-plus"></i> Add Manual Task
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm table-sortable" id="tasksTable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Task</th>
                                <th data-sortable data-sort-type="text">Assigned To</th>
                                <th data-sortable data-sort-type="text">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr id="task-row-{{ task.id }}" data-task-id="{{ task.id }}">
                                <td>
                                    {% if task.janitorial_task_id %}
                                        üßπ
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'üîò' }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'üîò' }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'üîò' }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'üîò' }}
                                    {% else %}
                                        üîò
                                    {% endif %}
                                    <strong>{{ task.description }}</strong>
                                    {% if task.batch and not task.batch.variable_yield %}
                                    <br><small class="text-muted">Yield: {{ task.batch.yield_amount }} {{ task.batch.yield_unit }}</small>
                                    {% elif task.batch and task.batch.variable_yield %}
                                    <br><small class="text-muted">Variable yield batch</small>
                                    {% endif %}
                                    {% if task.status == "in_progress" %}
                                    <br><small class="text-info timer" data-task-id="{{ task.id }}" data-started="{{ task.started_at.isoformat() if task.started_at else '' }}">
                                        <i class="fas fa-clock"></i> <span class="timer-display">0:00</span>
                                    </small>
                                    {% endif %}
                                </td>
                                <td class="assigned-to-cell" data-task-id="{{ task.id }}">
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <span class="text-info">Team of {{ employee_ids|length }}</span>
                                            <br>
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        <span class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        {{ emp.full_name or emp.username }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        {{ task.assigned_to.full_name or task.assigned_to.username }}
                                    {% else %}
                                        <span class="text-warning">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td class="status-cell task-status" data-task-id="{{ task.id }}">
                                    {% if task.status == "not_started" %}
                                        <span class="badge bg-secondary">Not Started</span>
                                    {% elif task.status == "in_progress" %}
                                        <span class="badge bg-primary">In Progress</span>
                                        <div class="live-timer mt-1" data-task-id="{{ task.id }}" data-started-at="{{ task.started_at.isoformat() if task.started_at else '' }}" data-pause-time="{{ task.total_pause_time or 0 }}">
                                            <small class="text-info">‚è±Ô∏è <span class="timer-display">0:00</span></small>
                                        </div>
                                    {% elif task.status == "paused" %}
                                        <span class="badge bg-warning">Paused</span>
                                        {% if task.started_at %}
                                        <br><small class="text-muted">{{ task.total_time_minutes }} min</small>
                                        {% endif %}
                                    {% elif task.status == "completed" %}
                                        <span class="badge bg-success">Completed</span>
                                        {% if task.finished_at %}
                                        <br><small class="text-muted">{{ task.total_time_minutes }} min</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="actions-cell" data-task-id="{{ task.id }}">
                                    {% if not inventory_day.finalized %}
                                        {% if not task.assigned_to and not task.assigned_employee_ids %}
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="showAssignModal({{ task.id }}, '{{ task.description }}')">
                                                <i class="fas fa-user-plus"></i> Assign
                                            </button>
                                        {% elif task.status == "not_started" %}
                                            {% if task.batch and task.batch.can_be_scaled and not task.batch.variable_yield %}
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name }}')">
                                                <i class="fas fa-play"></i> Start
                                            </button>
                                            {% else %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                            </form>
                                            {% endif %}
                                            {% if task.assigned_to or task.assigned_employee_ids %}
                                            <br><button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                                    onclick="showAssignModal({{ task.id }}, '{{ task.description }}')">
                                                <i class="fas fa-user-edit"></i> Reassign
                                            </button>
                                            {% endif %}
                                        {% elif task.status == "in_progress" %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-warning">
                                                    <i class="fas fa-pause"></i> Pause
                                                </button>
                                            </form>
                                            {% if task.requires_made_amount %}
                                            <button type="button" class="btn btn-sm btn-success" 
                                                    onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                <i class="fas fa-check"></i> Finish
                                            </button>
                                            {% else %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="fas fa-check"></i> Finish
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% elif task.status == "paused" %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-info">
                                                    <i class="fas fa-play"></i> Resume
                                                </button>
                                            </form>
                                            {% if task.requires_made_amount %}
                                            <br><button type="button" class="btn btn-sm btn-success mt-1" 
                                                    onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                <i class="fas fa-check"></i> Finish & Enter Amount
                                            </button>
                                            {% endif %}
                                        {% elif task.status == "completed" %}
                                            <span class="text-success"><i class="fas fa-check-circle"></i> Done</span>
                                        {% endif %}
                                    {% else %}
                                        {% if task.assigned_to or task.assigned_employee_ids %}
                                            {% if task.status == "not_started" %}
                                                {% if task.batch and task.batch.can_be_scaled and not task.batch.variable_yield %}
                                                <button type="button" class="btn btn-sm btn-primary" 
                                                        onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% else %}
                                                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-play"></i> Start
                                                    </button>
                                                </form>
                                                {% endif %}
                                                <br><button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                                        onclick="showAssignModal({{ task.id }}, '{{ task.description }}')">
                                                    <i class="fas fa-user-edit"></i> Reassign
                                                </button>
                                            {% elif task.status == "in_progress" %}
                                                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-pause"></i> Pause
                                                    </button>
                                                </form>
                                                {% if task.requires_made_amount %}
                                                <br><button type="button" class="btn btn-sm btn-success mt-1" 
                                                        onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                    <i class="fas fa-check"></i> Finish & Enter Amount
                                                </button>
                                                {% else %}
                                                <br><form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-success mt-1">
                                                        <i class="fas fa-check"></i> Finish
                                                    </button>
                                                </form>
                                                {% endif %}
                                            {% elif task.status == "paused" %}
                                                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-info">
                                                        <i class="fas fa-play"></i> Resume
                                                    </button>
                                                </form>
                                                {% if task.requires_made_amount %}
                                                <br><button type="button" class="btn btn-sm btn-success mt-1" 
                                                        onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                    <i class="fas fa-check"></i> Finish & Enter Amount
                                                </button>
                                                {% endif %}
                                            {% elif task.status == "completed" %}
                                                <span class="text-success"><i class="fas fa-check-circle"></i> Done</span>
                                            {% endif %}
                                        {% else %}
                                            <!-- Unassigned tasks can still be started -->
                                            {% if task.status == "not_started" %}
                                                {% if task.batch and task.batch.can_be_scaled and not task.batch.variable_yield %}
                                                <button type="button" class="btn btn-sm btn-primary" 
                                                        onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% else %}
                                                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-play"></i> Start
                                                    </button>
                                                </form>
                                                {% endif %}
                                                <br><button type="button" class="btn btn-sm btn-outline-primary mt-1" 
                                                        onclick="showAssignModal({{ task.id }}, '{{ task.description }}')">
                                                    <i class="fas fa-user-plus"></i> Assign
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No tasks generated yet.</p>
                {% endif %}
            </div>
        </div>
        
        {% if not inventory_day.finalized %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Day Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/finalize">
                        <button type="submit" class="btn btn-success w-100" 
                                onclick="return confirm('Are you sure you want to finalize this day? This cannot be undone.')">
                            <i class="fas fa-check-circle"></i> Finalize Day
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Manual Task Modal -->
{% if current_user.role in ["admin", "manager"] and not inventory_day.finalized %}
<div class="modal fade" id="manualTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Manual Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/new">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="manualDescription" class="form-label">Task Description</label>
                        <input type="text" class="form-control" id="manualDescription" name="description" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualInventoryItem" class="form-label">Inventory Item (Optional)</label>
                                <select class="form-select" id="manualInventoryItem" name="inventory_item_id">
                                    <option value="">No inventory item</option>
                                    {% for item in inventory_day_items %}
                                    <option value="{{ item.inventory_item_id }}">{{ item.inventory_item.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualBatch" class="form-label">Batch (Optional)</label>
                                <select class="form-select" id="manualBatch" name="batch_id">
                                    <option value="">No batch</option>
                                    {% for batch in batches %}
                                    <option value="{{ batch.id }}">{{ batch.recipe.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualCategory" class="form-label">Category (Optional)</label>
                        <select class="form-select" id="manualCategory" name="category_id">
                            <option value="">No category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.icon or 'üîò' }} {{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign To:</label>
                        {% for emp in employees %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="manual_emp{{ emp.id }}">
                            <label class="form-check-label" for="manual_emp{{ emp.id }}">
                                {{ emp.full_name or emp.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Assignment Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignModalTitle">Assign Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Assign to employees:</label>
                        <div id="employeeCheckboxes">
                            {% for emp in employees %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="assign_emp{{ emp.id }}">
                                <label class="form-check-label" for="assign_emp{{ emp.id }}">
                                    {{ emp.full_name or emp.username }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SSE Connection Status (hidden by default) -->
<div id="connectionStatus" class="alert alert-warning" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 1050;">
    <i class="fas fa-wifi"></i> <span id="connectionText">Connecting...</span>
</div>

<script>
// SSE Connection and Event Handling
let eventSource = null;
let connectionRetryCount = 0;
const maxRetries = 5;

function initializeSSE() {
    console.log('Initializing SSE connection for day {{ inventory_day.id }}');
    
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource('/events/inventory/{{ inventory_day.id }}');
    
    eventSource.onopen = function(event) {
        console.log('SSE connection opened');
        connectionRetryCount = 0;
        hideConnectionStatus();
    };
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('SSE event received:', data);
            handleSSEEvent(data);
        } catch (error) {
            console.error('Error parsing SSE data:', error);
        }
    };
    
    eventSource.onerror = function(event) {
        console.error('SSE connection error:', event);
        
        if (connectionRetryCount < maxRetries) {
            connectionRetryCount++;
            showConnectionStatus(`Reconnecting... (${connectionRetryCount}/${maxRetries})`);
            
            setTimeout(() => {
                initializeSSE();
            }, 2000 * connectionRetryCount);
        } else {
            showConnectionStatus('Connection failed. Please refresh the page.');
        }
    };
}

function handleSSEEvent(data) {
    console.log('Handling SSE event:', data.type, data);
    
    switch (data.type) {
        case 'connected':
            console.log('SSE connected to day', data.day_id);
            break;
            
        case 'task_assigned':
            updateTaskAssignment(data.task_id, data.assigned_employees, data.team_size);
            break;
            
        case 'task_started':
            updateTaskStatus(data.task_id, 'in_progress', data.started_at);
            addTimerToTask(data.task_id, data.started_at);
            break;
            
        case 'task_paused':
            updateTaskStatus(data.task_id, 'paused');
            removeTimerFromTask(data.task_id);
            break;
            
        case 'task_resumed':
            updateTaskStatus(data.task_id, 'in_progress', data.resumed_at);
            addTimerToTask(data.task_id, data.resumed_at);
            break;
            
        case 'task_completed':
            updateTaskStatus(data.task_id, 'completed', null, data.total_time, data.labor_cost);
            removeTimerFromTask(data.task_id);
            break;
            
        case 'inventory_batch_updated':
            if (data.force_regenerate) {
                console.log('Force regenerate detected, reloading page...');
                setTimeout(() => location.reload(), 500);
            }
            break;
            
        case 'tasks_generated':
            console.log('Tasks generated, reloading page...');
            setTimeout(() => location.reload(), 500);
            break;
            
        case 'day_finalized':
            console.log('Day finalized, reloading page...');
            setTimeout(() => location.reload(), 1000);
            break;
            
        case 'heartbeat':
            // Keep connection alive
            break;
            
        default:
            console.log('Unknown SSE event type:', data.type);
    }
    
    // Handle SSE events for task status updates
    if (data.type === 'task_paused') {
        const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
        if (taskRow) {
            const statusCell = taskRow.querySelector('.task-status');
            if (statusCell) {
                statusCell.innerHTML = '<span class="badge bg-warning">Paused</span>';
                
                // Remove timer when paused
                const timer = statusCell.querySelector('.live-timer');
                if (timer) {
                    timer.remove();
                }
            }
        }
    } else if (data.type === 'task_resumed') {
        const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
        if (taskRow) {
            const statusCell = taskRow.querySelector('.task-status');
            if (statusCell) {
                statusCell.innerHTML = '<span class="badge bg-primary">In Progress</span>';
                
                // Add timer back when resumed
                const timerDiv = document.createElement('div');
                timerDiv.className = 'live-timer mt-1';
                timerDiv.dataset.taskId = data.task_id;
                timerDiv.dataset.startedAt = data.resumed_at;
                timerDiv.dataset.pauseTime = data.total_pause_time || 0;
                timerDiv.innerHTML = '<small class="text-info">‚è±Ô∏è <span class="timer-display">0m</span></small>';
                statusCell.appendChild(timerDiv);
            }
        }
    } else if (data.type === 'task_completed') {
        const taskRow = document.querySelector(`tr[data-task-id="${data.task_id}"]`);
        if (taskRow) {
            const statusCell = taskRow.querySelector('.task-status');
            if (statusCell) {
                statusCell.innerHTML = '<span class="badge bg-success">Completed</span>';
                
                // Remove timer when completed
                const timer = statusCell.querySelector('.live-timer');
                if (timer) {
                    timer.remove();
                }
            }
        }
    }
}

function updateTaskAssignment(taskId, assignedEmployees, teamSize) {
    console.log('Updating task assignment for task', taskId, 'employees:', assignedEmployees);
    
    const assignedCell = document.querySelector(`.assigned-to-cell[data-task-id="${taskId}"]`);
    if (!assignedCell) {
        console.error('Could not find assigned-to cell for task', taskId);
        return;
    }
    
    if (assignedEmployees && assignedEmployees.length > 0) {
        if (teamSize > 1) {
            assignedCell.innerHTML = `
                <span class="text-info">Team of ${teamSize}</span><br>
                ${assignedEmployees.map(emp => `<span class="badge bg-secondary me-1">${emp}</span>`).join('')}
            `;
        } else {
            assignedCell.innerHTML = assignedEmployees[0];
        }
    } else {
        assignedCell.innerHTML = '<span class="text-warning">Unassigned</span>';
    }
    
    // Update actions cell to show start button instead of assign button
    updateTaskActions(taskId, 'not_started', true);
    
    console.log('Task assignment updated successfully');
}

function updateTaskStatus(taskId, status, startedAt = null, totalTime = null, laborCost = null) {
    console.log('Updating task status for task', taskId, 'to', status);
    
    const statusCell = document.querySelector(`.status-cell[data-task-id="${taskId}"]`);
    if (!statusCell) {
        console.error('Could not find status cell for task', taskId);
        return;
    }
    
    let statusHtml = '';
    
    switch (status) {
        case 'not_started':
            statusHtml = '<span class="badge bg-secondary">Not Started</span>';
            break;
            
        case 'in_progress':
            statusHtml = '<span class="badge bg-primary">In Progress</span>';
            break;
            
        case 'paused':
            statusHtml = '<span class="badge bg-warning">Paused</span>';
            if (totalTime) {
                statusHtml += `<br><small class="text-muted">${totalTime} min</small>`;
            }
            break;
            
        case 'completed':
            statusHtml = '<span class="badge bg-success">Completed</span>';
            if (totalTime) {
                statusHtml += `<br><small class="text-muted">${totalTime} min</small>`;
            }
            break;
    }
    
    statusCell.innerHTML = statusHtml;
    
    // Update actions based on new status
    updateTaskActions(taskId, status, true);
    
    console.log('Task status updated successfully');
}

function updateTaskActions(taskId, status, hasAssignment = false) {
    const actionsCell = document.querySelector(`.actions-cell[data-task-id="${taskId}"]`);
    if (!actionsCell) {
        console.error('Could not find actions cell for task', taskId);
        return;
    }
    
    let actionsHtml = '';
    
    if (!hasAssignment) {
        actionsHtml = `
            <button type="button" class="btn btn-sm btn-outline-primary" 
                    onclick="showAssignModal(${taskId}, 'Task')">
                <i class="fas fa-user-plus"></i> Assign
            </button>
        `;
    } else {
        switch (status) {
            case 'not_started':
                actionsHtml = `
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-play"></i> Start
                        </button>
                    </form>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="showAssignModal(${taskId}, 'Task')">
                        <i class="fas fa-user-edit"></i> Reassign
                    </button>
                `;
                break;
                
            case 'in_progress':
                actionsHtml = `
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/pause" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-warning">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                    </form>
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="fas fa-check"></i> Finish
                        </button>
                    </form>
                `;
                break;
                
            case 'paused':
                actionsHtml = `
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/resume" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-info">
                            <i class="fas fa-play"></i> Resume
                        </button>
                    </form>
                `;
                break;
                
            case 'completed':
                actionsHtml = '<span class="text-success"><i class="fas fa-check-circle"></i> Done</span>';
                break;
        }
    }
    
    // Always add view button
    actionsHtml += `
        <a href="/inventory/day/{{ inventory_day.id }}/tasks/${taskId}" class="btn btn-sm btn-outline-info">
            <i class="fas fa-eye"></i>
        </a>
    `;
    
    actionsCell.innerHTML = actionsHtml;
}

// Connection status functions
function showConnectionStatus(message) {
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    statusText.textContent = message;
    statusDiv.style.display = 'block';
}

function hideConnectionStatus() {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.style.display = 'none';
}

// Modal functions
function showAssignModal(taskId, taskDescription) {
    const modal = document.getElementById('assignModal');
    const title = document.getElementById('assignModalTitle');
    const form = document.getElementById('assignForm');
    
    title.textContent = `Assign: ${taskDescription}`;
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/assign_multiple`;
    
    // Clear previous selections
    document.querySelectorAll('#employeeCheckboxes input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}

function showScaleSelection(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/scale_options`)
        .then(response => response.json())
        .then(scales => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Batch Scale - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select batch scale to make:</label>
                                <select class="form-select" id="scaleSelect" required>
                                    <option value="">Choose scale...</option>
                                    ${scales.map(scale => 
                                        `<option value="${scale.key}" data-yield="${scale.yield}">${scale.label} - ${scale.yield}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="startTaskWithScale(${taskId})">Start Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading scale options:', error);
            alert('Error loading scale options');
        });
}

function startTaskWithScale(taskId) {
    const scaleSelect = document.getElementById('scaleSelect');
    const selectedScale = scaleSelect.value;
    
    if (!selectedScale) {
        alert('Please select a batch scale');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start_with_scale`;
    form.style.display = 'none';
    
    const scaleInput = document.createElement('input');
    scaleInput.name = 'selected_scale';
    scaleInput.value = selectedScale;
    
    form.appendChild(scaleInput);
    document.body.appendChild(form);
    form.submit();
}

function showMadeAmountInput(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/finish_requirements`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Amount Made - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Amount Made:</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-control-plaintext">
                                            <strong>${data.use_par_unit ? data.par_unit_name : (data.available_units && data.available_units.length > 0 ? data.available_units[0] : 'units')}</strong>
                                        </div>
                                        <input type="hidden" id="madeUnit" value="${data.use_par_unit ? data.par_unit_name : (data.available_units && data.available_units.length > 0 ? data.available_units[0] : 'units')}">
                                    </div>
                                </div>
                                ${data.use_par_unit && data.par_unit_equals_info ? `
                                <small class="text-info">${data.par_unit_equals_info.description}</small>
                                ` : ''}
                            </div>
                            ${data.inventory_info ? `
                            <div class="alert alert-info">
                                <small>
                                    <strong>Current Inventory:</strong> ${data.inventory_info.current} ${data.inventory_info.par_unit_name}<br>
                                    <strong>Par Level:</strong> ${data.inventory_info.par_level} ${data.inventory_info.par_unit_name}
                                </small>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="finishTaskWithAmount(${taskId})">Finish Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading finish requirements:', error);
            alert('Error loading task requirements');
        });
}

function finishTaskWithAmount(taskId) {
    const madeAmount = document.getElementById('madeAmount').value;
    const madeUnitInput = document.getElementById('madeUnit');
    const madeUnit = madeUnitInput ? madeUnitInput.value : '';
    
    if (!madeAmount || !madeUnit) {
        alert('Please enter amount made and select unit');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish_with_amount`;
    form.style.display = 'none';
    
    const amountInput = document.createElement('input');
    amountInput.name = 'made_amount';
    amountInput.value = madeAmount;
    
    const unitInput = document.createElement('input');
    unitInput.name = 'made_unit';
    unitInput.value = madeUnit;
    
    form.appendChild(amountInput);
    form.appendChild(unitInput);
    document.body.appendChild(form);
    form.submit();
}

// Initialize SSE when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inventory day page loaded');
    initializeSSE();
    startLiveTimers();
});

// Live timer functionality
function startLiveTimers() {
    console.log('Starting live timers');
    
    // Update timers every second
    setInterval(updateTimers, 1000);
    
    // Initial update
    updateTimers();
}

function updateTimers() {
    const timers = document.querySelectorAll('.live-timer');
    const now = new Date();
    
    timers.forEach(timer => {
        const startedAt = timer.dataset.startedAt;
        const pauseTime = parseInt(timer.dataset.pauseTime) || 0;
        const display = timer.querySelector('.timer-display');
        
        if (startedAt && display) {
            const startTime = new Date(startedAt);
            const elapsedMs = now - startTime - (pauseTime * 1000); // Subtract pause time
            const totalMinutes = Math.floor(elapsedMs / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            // Format as H:MM or MM (no seconds)
            let timeString;
            if (hours > 0) {
                timeString = `${hours}:${minutes.toString().padStart(2, '0')}`;
            } else {
                timeString = `${minutes}`;
            }
            
            display.textContent = timeString + (hours > 0 ? 'h' : 'm');
        }
    });
}

function addTimerToTask(taskId, startedAt) {
    const taskRow = document.querySelector(`tr[data-task-id="${taskId}"] td:first-child`);
    if (taskRow) {
        // Remove existing timer if any
        const existingTimer = taskRow.querySelector('.timer');
        if (existingTimer) {
            existingTimer.remove();
        }
        
        // Add new timer
        const timerElement = document.createElement('small');
        timerElement.className = 'text-info timer';
        timerElement.dataset.taskId = taskId;
        timerElement.dataset.started = startedAt;
        timerElement.innerHTML = '<br><i class="fas fa-clock"></i> <span class="timer-display">0:00</span>';
        
        taskRow.appendChild(timerElement);
    }
}

function removeTimerFromTask(taskId) {
    const timer = document.querySelector(`.timer[data-task-id="${taskId}"]`);
    if (timer) {
        timer.remove();
    }
}

// Clean up when page unloads
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}