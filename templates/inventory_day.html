{% extends "base.html" %}

{% block title %}Inventory Day {{ inventory_day.date }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar-day"></i> Inventory Day: {{ inventory_day.date }}</h1>
        <a href="/inventory" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Inventory
        </a>
        
        {% if inventory_day.finalized %}
        <span class="badge bg-success ms-2">Finalized</span>
        {% else %}
        <span class="badge bg-warning ms-2">In Progress</span>
        {% endif %}
        
        <!-- SSE Connection Status -->
        <div id="connectionStatus" class="alert alert-info mt-2" style="display: none;">
            <i class="fas fa-wifi"></i> <span id="connectionText">Connecting...</span>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Daily Inventory</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/update" id="inventoryForm">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="global_notes" class="form-label">Day Notes</label>
                            <textarea class="form-control" id="global_notes" name="global_notes" rows="2" placeholder="General notes for the day...">{{ inventory_day.global_notes or '' }}</textarea>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="force_regenerate" name="force_regenerate">
                                <label class="form-check-label" for="force_regenerate">
                                    Force Regenerate Tasks
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync"></i> Update & Generate Tasks
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-sortable">
                            <thead>
                                <tr>
                                    <th data-sortable data-sort-type="text">Item</th>
                                    <th data-sortable data-sort-type="number">Quantity</th>
                                    <th data-sortable data-sort-type="number">Par Level</th>
                                    <th data-sortable data-sort-type="text">Status</th>
                                    <th>Override</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_item in inventory_day_items %}
                                {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                                {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                                {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                                <tr class="{% if is_below_par %}below-par{% elif is_near_par %}near-par{% endif %}">
                                    <td>
                                        {% if day_item.inventory_item.category %}
                                            {{ day_item.inventory_item.category.icon or 'ðŸ”˜' }}
                                        {% else %}
                                            ðŸ”˜
                                        {% endif %}
                                        <strong>{{ day_item.inventory_item.name }}</strong>
                                        {% if day_item.inventory_item.batch %}
                                        <br><small class="text-muted">Linked: {{ day_item.inventory_item.batch.recipe.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="item_{{ day_item.inventory_item.id }}" 
                                               value="{{ day_item.quantity }}" step="0.1" min="0">
                                        {% if day_item.inventory_item.par_unit_name %}
                                        <small class="text-muted">{{ day_item.inventory_item.par_unit_name.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ day_item.inventory_item.par_level }}
                                        {% if day_item.inventory_item.par_unit_name %}
                                        <br><small class="text-muted">{{ day_item.inventory_item.par_unit_name.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if is_below_par %}
                                            <span class="badge bg-danger">Below Par</span>
                                        {% elif is_on_par %}
                                            <span class="badge bg-info">On Par</span>
                                        {% elif is_near_par %}
                                            <span class="badge bg-warning">Near Par</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if is_below_par %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="override_no_task_{{ day_item.inventory_item.id }}" 
                                                   {% if day_item.override_no_task %}checked{% endif %}>
                                            <label class="form-check-label">
                                                <small>Skip Task</small>
                                            </label>
                                        </div>
                                        {% else %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="override_create_{{ day_item.inventory_item.id }}" 
                                                   {% if day_item.override_create_task %}checked{% endif %}>
                                            <label class="form-check-label">
                                                <small>Create Task</small>
                                            </label>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-striped table-sortable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Item</th>
                                <th data-sortable data-sort-type="number">Quantity</th>
                                <th data-sortable data-sort-type="number">Par Level</th>
                                <th data-sortable data-sort-type="text">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_item in inventory_day_items %}
                            {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                            {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                            {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                            <tr class="{% if is_below_par %}below-par{% elif is_near_par %}near-par{% endif %}">
                                <td>
                                    {% if day_item.inventory_item.category %}
                                        {{ day_item.inventory_item.category.icon or 'ðŸ”˜' }}
                                    {% else %}
                                        ðŸ”˜
                                    {% endif %}
                                    <strong>{{ day_item.inventory_item.name }}</strong>
                                    {% if day_item.inventory_item.batch %}
                                    <br><small class="text-muted">Linked: {{ day_item.inventory_item.batch.recipe.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ day_item.quantity }}
                                    {% if day_item.inventory_item.par_unit_name %}
                                    <br><small class="text-muted">{{ day_item.inventory_item.par_unit_name.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ day_item.inventory_item.par_level }}
                                    {% if day_item.inventory_item.par_unit_name %}
                                    <br><small class="text-muted">{{ day_item.inventory_item.par_unit_name.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if is_below_par %}
                                        <span class="badge bg-danger">Below Par</span>
                                    {% elif is_on_par %}
                                        <span class="badge bg-info">On Par</span>
                                    {% elif is_near_par %}
                                        <span class="badge bg-warning">Near Par</span>
                                    {% else %}
                                        <span class="badge bg-success">Good</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-broom"></i> Janitorial Tasks</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/update">
                    <div class="row">
                        {% for janitorial_day_item in janitorial_day_items %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       name="janitorial_{{ janitorial_day_item.janitorial_task.id }}" 
                                       id="janitorial_{{ janitorial_day_item.janitorial_task.id }}"
                                       {% if janitorial_day_item.include_task %}checked{% endif %}
                                       {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}disabled{% endif %}>
                                <label class="form-check-label" for="janitorial_{{ janitorial_day_item.janitorial_task.id }}">
                                    ðŸ§¹ {{ janitorial_day_item.janitorial_task.title }}
                                    {% if janitorial_day_item.janitorial_task.task_type == 'daily' %}
                                    <span class="badge bg-primary ms-1">Daily</span>
                                    {% endif %}
                                </label>
                                {% if janitorial_day_item.janitorial_task.instructions %}
                                <br><small class="text-muted">{{ janitorial_day_item.janitorial_task.instructions[:50] }}{% if janitorial_day_item.janitorial_task.instructions|length > 50 %}...{% endif %}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn btn-secondary mt-2">
                        <i class="fas fa-sync"></i> Update Janitorial Tasks
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Add Manual Task</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/new">
                    <div class="mb-3">
                        <label for="description" class="form-label">Task Description</label>
                        <input type="text" class="form-control" id="description" name="description" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="inventory_item_id" class="form-label">Linked Inventory Item (Optional)</label>
                        <select class="form-select" id="inventory_item_id" name="inventory_item_id">
                            <option value="">No inventory item</option>
                            {% for day_item in inventory_day_items %}
                            <option value="{{ day_item.inventory_item.id }}">{{ day_item.inventory_item.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batch_id" class="form-label">Linked Batch (Optional)</label>
                        <select class="form-select" id="batch_id" name="batch_id">
                            <option value="">No batch</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}">{{ batch.recipe.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category (Optional)</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">No category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.icon or 'ðŸ”˜' }} {{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign To (Multiple Selection)</label>
                        {% for emp in employees %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="emp_{{ emp.id }}">
                            <label class="form-check-label" for="emp_{{ emp.id }}">
                                {{ emp.full_name or emp.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Day Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Date:</strong> {{ inventory_day.date }}</p>
                <p><strong>Status:</strong> 
                    {% if inventory_day.finalized %}
                        <span class="badge bg-success">Finalized</span>
                    {% else %}
                        <span class="badge bg-warning">In Progress</span>
                    {% endif %}
                </p>
                {% if inventory_day.employees_working %}
                <p><strong>Employees Working:</strong></p>
                <ul class="list-unstyled">
                    {% set employee_ids = inventory_day.employees_working.split(',') %}
                    {% for emp_id in employee_ids %}
                        {% for emp in employees %}
                            {% if emp.id|string == emp_id %}
                            <li><i class="fas fa-user"></i> {{ emp.full_name or emp.username }}</li>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                <hr>
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/finalize">
                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Are you sure you want to finalize this day? This cannot be undone.')">
                        <i class="fas fa-lock"></i> Finalize Day
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Tasks</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sortable">
                        <thead>
                            <tr>
                                <th data-sortable data-sort-type="text">Task</th>
                                <th data-sortable data-sort-type="text">Assigned To</th>
                                <th data-sortable data-sort-type="text">Status</th>
                                <th data-sortable data-sort-type="text">Time</th>
                                <th data-sortable data-sort-type="text">Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr data-task-id="{{ task.id }}">
                                <td>
                                    {% if task.janitorial_task_id %}
                                        ðŸ§¹
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'ðŸ”˜' }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'ðŸ”˜' }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'ðŸ”˜' }}
                                    {% else %}
                                        ðŸ”˜
                                    {% endif %}
                                    <strong>{{ task.description }}</strong>
                                    {% if task.batch and task.selected_scale and task.selected_scale != 'full' %}
                                    <br><small class="text-info">Scale: {{ task.selected_scale.replace('_', ' ').title() }}</small>
                                    {% endif %}
                                    {% if task.made_amount and task.made_unit %}
                                    <br><small class="text-success">Made: {{ task.made_amount }} {{ task.made_unit }}</small>
                                    {% endif %}
                                    {% if task.notes %}
                                    <br><small class="text-muted">{{ task.notes[:50] }}{% if task.notes|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td class="task-assigned-to" data-task-id="{{ task.id }}">
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <span class="text-info">Team of {{ employee_ids|length }}</span>
                                            <br>
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        <span class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        {{ emp.full_name or emp.username }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        {{ task.assigned_to.full_name or task.assigned_to.username }}
                                    {% else %}
                                        {% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
                                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal{{ task.id }}">
                                            <i class="fas fa-user-plus"></i> Assign
                                        </button>
                                        {% else %}
                                        <span class="text-warning">Unassigned</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="task-status" data-task-id="{{ task.id }}">
                                    {% if task.status == "not_started" %}
                                        <span class="badge bg-secondary">Not Started</span>
                                    {% elif task.status == "in_progress" %}
                                        <span class="badge bg-primary">In Progress</span>
                                        {% if task.started_at %}
                                        <br><small class="text-muted timer" data-start-time="{{ task.started_at.isoformat() }}" data-pause-time="{{ task.total_pause_time }}">
                                            {{ task.total_time_minutes }} min
                                        </small>
                                        {% endif %}
                                    {% elif task.status == "paused" %}
                                        <span class="badge bg-warning">Paused</span>
                                        {% if task.started_at %}
                                        <br><small class="text-muted">{{ task.total_time_minutes }} min</small>
                                        {% endif %}
                                    {% elif task.status == "completed" %}
                                        <span class="badge bg-success">Completed</span>
                                        {% if task.finished_at %}
                                        <br><small class="text-muted">{{ task.total_time_minutes }} min</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.started_at %}
                                        {{ task.total_time_minutes }} min
                                        {% if task.total_pause_time > 0 %}
                                        <br><small class="text-warning">Paused: {{ (task.total_pause_time / 60)|round(1) }} min</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.janitorial_task_id %}
                                        ðŸ§¹ Janitorial
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'ðŸ”˜' }} {{ task.inventory_item.category.name }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }} {{ task.inventory_item.batch.category.name }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'ðŸ”˜' }} {{ task.batch.category.name }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'ðŸ”˜' }} {{ task.category.name }}
                                    {% else %}
                                        ðŸ”˜ Uncategorized
                                    {% endif %}
                                </td>
                                <td class="task-actions" data-task-id="{{ task.id }}">
                                    {% if not inventory_day.finalized and current_user.role in ["admin", "manager", "user"] %}
                                        {% if task.status == "not_started" %}
                                            {% if task.assigned_to or task.assigned_employee_ids %}
                                                {% if task.batch and task.batch.can_be_scaled and not task.batch.variable_yield %}
                                                <button type="button" class="btn btn-sm btn-primary" onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% else %}
                                                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-play"></i> Start
                                                    </button>
                                                </form>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Assign first</span>
                                            {% endif %}
                                        {% elif task.status == "in_progress" %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-warning">
                                                    <i class="fas fa-pause"></i> Pause
                                                </button>
                                            </form>
                                            {% if task.requires_made_amount %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                <i class="fas fa-check"></i> Finish & Enter Amount
                                            </button>
                                            {% else %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="fas fa-check"></i> Finish
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% elif task.status == "paused" %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-info">
                                                    <i class="fas fa-play"></i> Resume
                                                </button>
                                            </form>
                                            {% if task.requires_made_amount %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                <i class="fas fa-check"></i> Finish & Enter Amount
                                            </button>
                                            {% else %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="fas fa-check"></i> Finish
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% elif task.status == "completed" %}
                                            <span class="badge bg-success">Done</span>
                                            {% if task.finished_at and task.assigned_to %}
                                            <br><small class="text-muted">Cost: ${{ "%.2f"|format(task.labor_cost) }}</small>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% else %}
                                        {% if task.status == "completed" %}
                                            <span class="badge bg-success">Completed</span>
                                        {% else %}
                                            <span class="text-muted">{{ task.status.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                        
                                        <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Modals -->
{% for task in tasks %}
{% if not task.assigned_to and not task.assigned_employee_ids and not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
<div class="modal fade" id="assignModal{{ task.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Task: {{ task.description }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/assign_multiple">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Employee(s):</label>
                        {% for emp in employees %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="assigned_to_ids" value="{{ emp.id }}" id="assign_emp_{{ task.id }}_{{ emp.id }}">
                            <label class="form-check-label" for="assign_emp_{{ task.id }}_{{ emp.id }}">
                                {{ emp.full_name or emp.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Task</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
// SSE Connection and Event Handling
let eventSource = null;
let dayId = {{ inventory_day.id }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, connecting to SSE...');
    connectToSSE();
    
    // Start live timers for in-progress tasks
    updateLiveTimers();
    setInterval(updateLiveTimers, 60000); // Update every minute
});

function connectToSSE() {
    console.log('Connecting to SSE for day:', dayId);
    
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource(`/events/inventory/${dayId}`);
    
    eventSource.onopen = function(event) {
        console.log('SSE connection opened');
        updateConnectionStatus('Connected', 'success');
    };
    
    eventSource.onmessage = function(event) {
        console.log('SSE message received:', event.data);
        
        try {
            const data = JSON.parse(event.data);
            console.log('Parsed SSE data:', data);
            
            // Handle different event types
            switch(data.type) {
                case 'connected':
                    console.log('SSE connection confirmed for day:', data.day_id);
                    break;
                    
                case 'task_assigned':
                    console.log('Task assigned event received:', data);
                    updateTaskAssignment(data.task_id, data.assigned_employees, data.team_size);
                    break;
                    
                case 'task_started':
                    console.log('Task started event received:', data);
                    updateTaskStatus(data.task_id, 'in_progress', data.started_at);
                    break;
                    
                case 'task_paused':
                    console.log('Task paused event received:', data);
                    updateTaskStatus(data.task_id, 'paused');
                    break;
                    
                case 'task_resumed':
                    console.log('Task resumed event received:', data);
                    updateTaskStatus(data.task_id, 'in_progress', data.resumed_at);
                    break;
                    
                case 'task_completed':
                    console.log('Task completed event received:', data);
                    updateTaskStatus(data.task_id, 'completed', null, data.total_time, data.labor_cost);
                    break;
                    
                case 'inventory_batch_updated':
                    console.log('Inventory batch updated event received:', data);
                    // This triggers a page reload for full inventory updates
                    if (data.force_regenerate) {
                        console.log('Force regenerate detected, reloading page...');
                        window.location.reload();
                    }
                    break;
                    
                case 'tasks_generated':
                    console.log('Tasks generated event received:', data);
                    // This triggers a page reload for new tasks
                    console.log('New tasks generated, reloading page...');
                    window.location.reload();
                    break;
                    
                case 'heartbeat':
                    // Silent heartbeat
                    break;
                    
                default:
                    console.log('Unknown SSE event type:', data.type);
            }
        } catch (error) {
            console.error('Error parsing SSE data:', error, event.data);
        }
    };
    
    eventSource.onerror = function(event) {
        console.error('SSE connection error:', event);
        updateConnectionStatus('Disconnected', 'danger');
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            console.log('Attempting to reconnect SSE...');
            connectToSSE();
        }, 5000);
    };
}

function updateConnectionStatus(status, type) {
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    if (statusDiv && statusText) {
        statusText.textContent = status;
        statusDiv.className = `alert alert-${type} mt-2`;
        statusDiv.style.display = 'block';
        
        // Hide success status after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
}

function updateTaskAssignment(taskId, assignedEmployees, teamSize) {
    console.log('Updating task assignment for task', taskId);
    
    const assignedCell = document.querySelector(`.task-assigned-to[data-task-id="${taskId}"]`);
    if (assignedCell) {
        console.log('Found assigned cell, updating...');
        
        if (teamSize > 1) {
            assignedCell.innerHTML = `
                <span class="text-info">Team of ${teamSize}</span><br>
                ${assignedEmployees.map(emp => `<span class="badge bg-secondary me-1">${emp}</span>`).join('')}
            `;
        } else if (assignedEmployees.length > 0) {
            assignedCell.innerHTML = assignedEmployees[0];
        }
        
        // Update action buttons - enable start button
        const actionsCell = document.querySelector(`.task-actions[data-task-id="${taskId}"]`);
        if (actionsCell) {
            const assignButton = actionsCell.querySelector('button[data-bs-target*="assignModal"]');
            if (assignButton) {
                assignButton.style.display = 'none';
            }
            
            // Add start button if not exists
            if (!actionsCell.querySelector('form[action*="/start"]')) {
                const startButton = document.createElement('form');
                startButton.method = 'post';
                startButton.action = `/inventory/day/${dayId}/tasks/${taskId}/start`;
                startButton.style.display = 'inline';
                startButton.innerHTML = `
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fas fa-play"></i> Start
                    </button>
                `;
                actionsCell.insertBefore(startButton, actionsCell.firstChild);
            }
        }
        
        console.log('Task assignment updated successfully');
    } else {
        console.error('Could not find assigned cell for task', taskId);
    }
}

function updateTaskStatus(taskId, status, startTime = null, totalTime = null, laborCost = null) {
    console.log('Updating task status for task', taskId, 'to', status);
    
    const statusCell = document.querySelector(`.task-status[data-task-id="${taskId}"]`);
    const actionsCell = document.querySelector(`.task-actions[data-task-id="${taskId}"]`);
    
    if (statusCell) {
        console.log('Found status cell, updating...');
        
        let statusHTML = '';
        switch(status) {
            case 'in_progress':
                statusHTML = `
                    <span class="badge bg-primary">In Progress</span>
                    ${startTime ? `<br><small class="text-muted timer" data-start-time="${startTime}" data-pause-time="0">0 min</small>` : ''}
                `;
                break;
            case 'paused':
                statusHTML = `
                    <span class="badge bg-warning">Paused</span>
                    ${totalTime ? `<br><small class="text-muted">${totalTime} min</small>` : ''}
                `;
                break;
            case 'completed':
                statusHTML = `
                    <span class="badge bg-success">Completed</span>
                    ${totalTime ? `<br><small class="text-muted">${totalTime} min</small>` : ''}
                `;
                break;
        }
        
        statusCell.innerHTML = statusHTML;
        
        // Update action buttons
        if (actionsCell) {
            updateActionButtons(actionsCell, taskId, status);
        }
        
        // Start live timer if task is in progress
        if (status === 'in_progress' && startTime) {
            updateLiveTimers();
        }
        
        console.log('Task status updated successfully');
    } else {
        console.error('Could not find status cell for task', taskId);
    }
}

function updateActionButtons(actionsCell, taskId, status) {
    console.log('Updating action buttons for task', taskId, 'status', status);
    
    // Clear existing action buttons (except view button)
    const viewButton = actionsCell.querySelector('a[href*="/tasks/"]');
    actionsCell.innerHTML = '';
    
    // Add appropriate buttons based on status
    switch(status) {
        case 'in_progress':
            actionsCell.innerHTML = `
                <form method="post" action="/inventory/day/${dayId}/tasks/${taskId}/pause" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-warning">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                </form>
                <form method="post" action="/inventory/day/${dayId}/tasks/${taskId}/finish" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-check"></i> Finish
                    </button>
                </form>
            `;
            break;
        case 'paused':
            actionsCell.innerHTML = `
                <form method="post" action="/inventory/day/${dayId}/tasks/${taskId}/resume" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-info">
                        <i class="fas fa-play"></i> Resume
                    </button>
                </form>
                <form method="post" action="/inventory/day/${dayId}/tasks/${taskId}/finish" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-check"></i> Finish
                    </button>
                </form>
            `;
            break;
        case 'completed':
            actionsCell.innerHTML = `
                <span class="badge bg-success">Done</span>
            `;
            break;
    }
    
    // Always add back the view button
    if (viewButton) {
        actionsCell.appendChild(viewButton);
    } else {
        const newViewButton = document.createElement('a');
        newViewButton.href = `/inventory/day/${dayId}/tasks/${taskId}`;
        newViewButton.className = 'btn btn-sm btn-outline-info';
        newViewButton.innerHTML = '<i class="fas fa-eye"></i>';
        actionsCell.appendChild(newViewButton);
    }
}

function updateLiveTimers() {
    const timers = document.querySelectorAll('.timer[data-start-time]');
    
    timers.forEach(timer => {
        const startTime = new Date(timer.dataset.startTime);
        const pauseTime = parseInt(timer.dataset.pauseTime) || 0;
        const now = new Date();
        
        const elapsedMs = now - startTime;
        const elapsedMinutes = Math.floor(elapsedMs / 60000) - Math.floor(pauseTime / 60);
        
        timer.textContent = `${elapsedMinutes} min`;
    });
}

// Scale Selection Modal
function showScaleSelection(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/scale_options`)
        .then(response => response.json())
        .then(scales => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Batch Scale - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select batch scale to make:</label>
                                <select class="form-select" id="scaleSelect" required>
                                    <option value="">Choose scale...</option>
                                    ${scales.map(scale => 
                                        `<option value="${scale.key}" data-yield="${scale.yield}">${scale.label} - ${scale.yield}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="startTaskWithScale(${taskId})">Start Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading scale options:', error);
            alert('Error loading scale options');
        });
}

function startTaskWithScale(taskId) {
    const scaleSelect = document.getElementById('scaleSelect');
    const selectedScale = scaleSelect.value;
    
    if (!selectedScale) {
        alert('Please select a batch scale');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/${dayId}/tasks/${taskId}/start_with_scale`;
    form.style.display = 'none';
    
    const scaleInput = document.createElement('input');
    scaleInput.name = 'selected_scale';
    scaleInput.value = selectedScale;
    
    form.appendChild(scaleInput);
    document.body.appendChild(form);
    form.submit();
}

// Made Amount Input Modal
function showMadeAmountInput(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/finish_requirements`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Amount Made - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Amount Made:</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-4" id="madeUnitSection" ${data.available_units.length === 1 ? 'style="display: none;"' : ''}>
                                        <select class="form-select" id="madeUnit" required>
                                            ${data.available_units.map(unit => 
                                                `<option value="${unit}">${unit}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                ${data.available_units.length === 1 ? `
                                <small class="text-info">Unit: ${data.available_units[0]}</small>
                                <input type="hidden" id="hiddenMadeUnit" value="${data.available_units[0]}">
                                ` : ''}
                            </div>
                            ${data.inventory_info ? `
                            <div class="alert alert-info">
                                <small>
                                    <strong>Current Inventory:</strong> ${data.inventory_info.current} ${data.inventory_info.par_unit_name}<br>
                                    <strong>Par Level:</strong> ${data.inventory_info.par_level} ${data.inventory_info.par_unit_name}
                                </small>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="finishTaskWithAmount(${taskId})">Finish Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading finish requirements:', error);
            alert('Error loading task requirements');
        });
}

function finishTaskWithAmount(taskId) {
    const madeAmount = document.getElementById('madeAmount').value;
    const madeUnitInput = document.getElementById('madeUnit');
    const hiddenMadeUnit = document.getElementById('hiddenMadeUnit');
    
    const madeUnit = madeUnitInput ? madeUnitInput.value : (hiddenMadeUnit ? hiddenMadeUnit.value : '');
    
    if (!madeAmount || !madeUnit) {
        alert('Please enter amount made and select unit');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/${dayId}/tasks/${taskId}/finish_with_amount`;
    form.style.display = 'none';
    
    const amountInput = document.createElement('input');
    amountInput.name = 'made_amount';
    amountInput.value = madeAmount;
    
    const unitInput = document.createElement('input');
    unitInput.name = 'made_unit';
    unitInput.value = madeUnit;
    
    form.appendChild(amountInput);
    form.appendChild(unitInput);
    document.body.appendChild(form);
    form.submit();
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}