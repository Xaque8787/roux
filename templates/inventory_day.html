{% extends "base.html" %}

{% block title %}Inventory Day {{ inventory_day.date }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar-day"></i> Inventory Day: {{ inventory_day.date.strftime('%Y-%m-%d') }}</h1>
        <a href="/inventory" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Inventory
        </a>
        
        {% if inventory_day.finalized %}
        <span class="badge bg-success ms-2">Finalized</span>
        {% else %}
        <span class="badge bg-warning ms-2">In Progress</span>
        {% endif %}
    </div>
</div>

<!-- Real-time connection status -->
<div class="row mb-3">
    <div class="col-12">
        <div id="connectionStatus" class="alert alert-info">
            <i class="fas fa-wifi"></i> Connecting to real-time updates...
        </div>
    </div>
</div>

<div class="row">
    <!-- Inventory Section -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Daily Inventory</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized %}
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/update" id="inventoryForm">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Par Level</th>
                                    <th>Current Qty</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_item in inventory_day_items %}
                                {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                                {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                                {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                                <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                    <td>
                                        {% if day_item.inventory_item.category %}
                                            {{ day_item.inventory_item.category.icon or 'ðŸ”˜' }}
                                        {% else %}
                                            ðŸ”˜
                                        {% endif %}
                                        <strong>{{ day_item.inventory_item.name }}</strong>
                                    </td>
                                    <td>
                                        {{ day_item.inventory_item.par_level }}
                                        {% if day_item.inventory_item.par_unit_name %}
                                            {{ day_item.inventory_item.par_unit_name.name }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="quantity_{{ day_item.inventory_item.id }}" 
                                               value="{{ day_item.quantity }}" 
                                               step="0.1" min="0" 
                                               onchange="updateRowStatus(this, {{ day_item.inventory_item.par_level }})">
                                    </td>
                                    <td>
                                        <span class="status-indicator">
                                            {% if is_below_par %}
                                                <span class="badge bg-danger">Below Par</span>
                                            {% elif is_on_par %}
                                                <span class="badge bg-info">On Par</span>
                                            {% elif is_near_par %}
                                                <span class="badge bg-warning">Near Par</span>
                                            {% else %}
                                                <span class="badge bg-success">Good</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" name="generate_tasks" value="true" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save & Generate Tasks
                        </button>
                        <button type="submit" name="save_only" value="true" class="btn btn-outline-primary">
                            <i class="fas fa-save"></i> Save Only
                        </button>
                    </div>
                </form>
                
                <div class="mt-3">
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/regenerate_tasks" 
                          onsubmit="return confirm('This will remove ALL tasks and reset inventory to 0. Are you sure?')">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-redo"></i> Regenerate Tasks (Start Fresh)
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Par Level</th>
                                <th>Final Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_item in inventory_day_items %}
                            {% set is_below_par = day_item.quantity < day_item.inventory_item.par_level %}
                            {% set is_on_par = day_item.quantity == day_item.inventory_item.par_level %}
                            {% set is_near_par = day_item.quantity == day_item.inventory_item.par_level + 1 %}
                            <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                <td>
                                    {% if day_item.inventory_item.category %}
                                        {{ day_item.inventory_item.category.icon or 'ðŸ”˜' }}
                                    {% else %}
                                        ðŸ”˜
                                    {% endif %}
                                    <strong>{{ day_item.inventory_item.name }}</strong>
                                </td>
                                <td>{{ day_item.inventory_item.par_level }}</td>
                                <td>{{ day_item.quantity }}</td>
                                <td>
                                    {% if is_below_par %}
                                        <span class="badge bg-danger">Below Par</span>
                                    {% elif is_on_par %}
                                        <span class="badge bg-info">On Par</span>
                                    {% elif is_near_par %}
                                        <span class="badge bg-warning">Near Par</span>
                                    {% else %}
                                        <span class="badge bg-success">Good</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tasks Section -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Tasks</h5>
            </div>
            <div class="card-body">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    {% if task.janitorial_task_id %}
                                        ðŸ§¹
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'ðŸ”˜' }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'ðŸ”˜' }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'ðŸ”˜' }}
                                    {% else %}
                                        ðŸ”˜
                                    {% endif %}
                                    <small>{{ task.description }}</small>
                                </td>
                                <td>
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <span class="text-info">Team of {{ employee_ids|length }}</span>
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id %}
                                                        <small>{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        <small>{{ task.assigned_to.full_name or task.assigned_to.username }}</small>
                                    {% else %}
                                        <small class="text-warning">Unassigned</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.status == "not_started" %}
                                        <span class="badge bg-secondary">Not Started</span>
                                    {% elif task.status == "in_progress" %}
                                        <span class="badge bg-primary">In Progress</span>
                                    {% elif task.status == "paused" %}
                                        <span class="badge bg-warning">Paused</span>
                                    {% elif task.status == "completed" %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not inventory_day.finalized %}
                                    <div class="btn-group" role="group">
                                        {% if not task.assigned_employee_ids and not task.assigned_to %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="showAssignModal({{ task.id }}, '{{ task.description }}')">
                                            <i class="fas fa-user-plus"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if task.status == "not_started" and (task.assigned_employee_ids or task.assigned_to) %}
                                            {% if task.batch and task.batch.can_be_scaled and not task.batch.variable_yield %}
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    onclick="showScaleSelection({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            {% else %}
                                            <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% elif task.status == "in_progress" %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-warning">
                                                <i class="fas fa-pause"></i>
                                            </button>
                                        </form>
                                        {% if task.requires_made_amount %}
                                        <button type="button" class="btn btn-sm btn-success" 
                                                onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% else %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        {% elif task.status == "paused" %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-info">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </form>
                                        {% if task.requires_made_amount %}
                                        <button type="button" class="btn btn-sm btn-success" 
                                                onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% else %}
                                        <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        {% endif %}
                                        
                                        <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                    {% else %}
                                    <a href="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No tasks for this day yet. Enter inventory quantities and click "Save & Generate Tasks".</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Janitorial Tasks Section -->
{% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-broom"></i> Add Janitorial Task</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/add_manual_task">
                    <div class="mb-3">
                        <label for="janitorial_task_id" class="form-label">Select Janitorial Task</label>
                        <select class="form-select" id="janitorial_task_id" name="janitorial_task_id">
                            <option value="">Select a janitorial task</option>
                            {% for janitorial_task in janitorial_tasks %}
                            <option value="{{ janitorial_task.id }}">{{ janitorial_task.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="custom_description" class="form-label">Or Custom Task Description</label>
                        <input type="text" class="form-control" id="custom_description" name="description" 
                               placeholder="Enter custom task description...">
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Add Manual Task</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/add_manual_task">
                    <div class="mb-3">
                        <label for="manual_description" class="form-label">Task Description</label>
                        <input type="text" class="form-control" id="manual_description" name="description" 
                               placeholder="Enter task description..." required>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">Select Category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.icon or 'ðŸ”˜' }} {{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="batch_id" class="form-label">Linked Batch (Optional)</label>
                        <select class="form-select" id="batch_id" name="batch_id">
                            <option value="">No batch linked</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}">{{ batch.recipe.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Manual Task
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Finalize Section -->
{% if not inventory_day.finalized and current_user.role in ["admin", "manager"] %}
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lock"></i> Finalize Day</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Once finalized, no further changes can be made to this inventory day.</p>
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/finalize" 
                      onsubmit="return confirm('Are you sure you want to finalize this day? This cannot be undone.')">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-lock"></i> Finalize Day
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Employee Assignment Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Description</label>
                        <p id="taskDescription" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign to Employees</label>
                        {% for emp in employees %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="assigned_employees" 
                                   value="{{ emp.id }}" id="emp_{{ emp.id }}">
                            <label class="form-check-label" for="emp_{{ emp.id }}">
                                {{ emp.full_name or emp.username }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// WebSocket connection for real-time updates
let socket = null;
const wsToken = '{{ websocket_token }}';

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/inventory/{{ inventory_day.id }}?token=${wsToken}`;
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function(event) {
        console.log('WebSocket connected');
        updateConnectionStatus('connected');
    };
    
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('WebSocket message:', data);
        
        if (data.type === 'task_update') {
            // Reload page on task updates
            window.location.reload();
        } else if (data.type === 'inventory_update') {
            // Reload page on inventory updates
            window.location.reload();
        } else if (data.type === 'user_count_update') {
            updateUserCount(data.user_count, data.users);
        }
    };
    
    socket.onclose = function(event) {
        console.log('WebSocket disconnected');
        updateConnectionStatus('disconnected');
        
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
    };
    
    socket.onerror = function(error) {
        console.error('WebSocket error:', error);
        updateConnectionStatus('error');
    };
}

function updateConnectionStatus(status) {
    const statusDiv = document.getElementById('connectionStatus');
    
    if (status === 'connected') {
        statusDiv.className = 'alert alert-success';
        statusDiv.innerHTML = '<i class="fas fa-wifi"></i> Connected to real-time updates';
    } else if (status === 'disconnected') {
        statusDiv.className = 'alert alert-warning';
        statusDiv.innerHTML = '<i class="fas fa-wifi"></i> Disconnected - attempting to reconnect...';
    } else if (status === 'error') {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Connection error - retrying...';
    }
}

function updateUserCount(count, users) {
    // Could add user count display if needed
    console.log(`${count} users connected:`, users);
}

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});

// Update row status when quantity changes
function updateRowStatus(input, parLevel) {
    const row = input.closest('tr');
    const quantity = parseFloat(input.value) || 0;
    const statusSpan = row.querySelector('.status-indicator span');
    
    // Remove existing classes
    row.classList.remove('table-danger', 'table-info', 'table-warning');
    
    if (quantity < parLevel) {
        row.classList.add('table-danger');
        statusSpan.className = 'badge bg-danger';
        statusSpan.textContent = 'Below Par';
    } else if (quantity === parLevel) {
        row.classList.add('table-info');
        statusSpan.className = 'badge bg-info';
        statusSpan.textContent = 'On Par';
    } else if (quantity === parLevel + 1) {
        row.classList.add('table-warning');
        statusSpan.className = 'badge bg-warning';
        statusSpan.textContent = 'Near Par';
    } else {
        statusSpan.className = 'badge bg-success';
        statusSpan.textContent = 'Good';
    }
}

// Show employee assignment modal
function showAssignModal(taskId, taskDescription) {
    document.getElementById('taskDescription').textContent = taskDescription;
    document.getElementById('assignForm').action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/assign`;
    
    // Clear previous selections
    document.querySelectorAll('input[name="assigned_employees"]').forEach(cb => cb.checked = false);
    
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    modal.show();
}

// Scale Selection Modal
function showScaleSelection(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/scale_options`)
        .then(response => response.json())
        .then(scales => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Batch Scale - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select batch scale to make:</label>
                                <select class="form-select" id="scaleSelect" required>
                                    <option value="">Choose scale...</option>
                                    ${scales.map(scale => 
                                        `<option value="${scale.key}" data-yield="${scale.yield}">${scale.label} - ${scale.yield}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="startTaskWithScale(${taskId})">Start Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading scale options:', error);
            alert('Error loading scale options');
        });
}

function startTaskWithScale(taskId) {
    const scaleSelect = document.getElementById('scaleSelect');
    const selectedScale = scaleSelect.value;
    
    if (!selectedScale) {
        alert('Please select a batch scale');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start_with_scale`;
    form.style.display = 'none';
    
    const scaleInput = document.createElement('input');
    scaleInput.name = 'selected_scale';
    scaleInput.value = selectedScale;
    
    form.appendChild(scaleInput);
    document.body.appendChild(form);
    form.submit();
}

// Made Amount Input Modal
function showMadeAmountInput(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/finish_requirements`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Amount Made - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Amount Made:</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-4" id="madeUnitSection" ${data.available_units.length === 1 ? 'style="display: none;"' : ''}>
                                        <select class="form-select" id="madeUnit" required>
                                            ${data.available_units.map(unit => 
                                                `<option value="${unit}">${unit}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                ${data.available_units.length === 1 ? `
                                <small class="text-info">Unit: ${data.available_units[0]}</small>
                                <input type="hidden" id="hiddenMadeUnit" value="${data.available_units[0]}">
                                ` : ''}
                            </div>
                            ${data.inventory_info ? `
                            <div class="alert alert-info">
                                <small>
                                    <strong>Current Inventory:</strong> ${data.inventory_info.current} ${data.inventory_info.par_unit_name}<br>
                                    <strong>Par Level:</strong> ${data.inventory_info.par_level} ${data.inventory_info.par_unit_name}
                                </small>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="finishTaskWithAmount(${taskId})">Finish Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading finish requirements:', error);
            alert('Error loading task requirements');
        });
}

function finishTaskWithAmount(taskId) {
    const madeAmount = document.getElementById('madeAmount').value;
    const madeUnitInput = document.getElementById('madeUnit');
    const hiddenMadeUnit = document.getElementById('hiddenMadeUnit');
    
    const madeUnit = madeUnitInput ? madeUnitInput.value : hiddenMadeUnit.value;
    
    if (!madeAmount || !madeUnit) {
        alert('Please enter amount made and select unit');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish_with_amount`;
    form.style.display = 'none';
    
    const amountInput = document.createElement('input');
    amountInput.name = 'made_amount';
    amountInput.value = madeAmount;
    
    const unitInput = document.createElement('input');
    unitInput.name = 'made_unit';
    unitInput.value = madeUnit;
    
    form.appendChild(amountInput);
    form.appendChild(unitInput);
    document.body.appendChild(form);
    form.submit();
}

// Handle janitorial task selection
document.addEventListener('DOMContentLoaded', function() {
    const janitorialSelect = document.getElementById('janitorial_task_id');
    const customDescription = document.getElementById('custom_description');
    
    if (janitorialSelect && customDescription) {
        janitorialSelect.addEventListener('change', function() {
            if (this.value) {
                customDescription.value = '';
                customDescription.disabled = true;
            } else {
                customDescription.disabled = false;
            }
        });
        
        customDescription.addEventListener('input', function() {
            if (this.value.trim()) {
                janitorialSelect.value = '';
                janitorialSelect.disabled = true;
            } else {
                janitorialSelect.disabled = false;
            }
        });
    }
});
</script>
{% endblock %}