{% extends "base.html" %}

{% block title %}Task Details - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-tasks"></i> Task Details</h1>
        <a href="/inventory/day/{{ inventory_day.id }}" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Inventory Day
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Task Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Description:</strong> {{ task.description }}</p>
                        <p><strong>Assigned to:</strong>
                            {% if task.assigned_employee_ids %}
                                {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                {% if employee_ids|length > 1 %}
                                    <span class="text-info">Team of {{ employee_ids|length }}</span>
                                    <br>
                                    {% for emp_id in employee_ids %}
                                        {% for emp in employees %}
                                            {% if emp.id|string == emp_id %}
                                                <span class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    {% for emp_id in employee_ids %}
                                        {% for emp in employees %}
                                            {% if emp.id|string == emp_id %}
                                                {{ emp.full_name or emp.username }}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                            {% elif task.assigned_to %}
                                {{ task.assigned_to.full_name or task.assigned_to.username }}
                            {% else %}
                                <span class="text-warning">Unassigned</span>
                            {% endif %}
                        </p>
                        <p><strong>Type:</strong> 
                            {% if task.auto_generated %}
                                <span class="badge bg-info">Auto-generated</span>
                            {% else %}
                                <span class="badge bg-secondary">Manual</span>
                            {% endif %}
                            {% if task.janitorial_task %}
                                <span class="badge bg-warning ms-1">Janitorial</span>
                            {% endif %}
                        </p>
                        <p><strong>Status:</strong> 
                            {% if task.status == "not_started" %}
                                <span class="badge bg-secondary">Not Started</span>
                            {% elif task.status == "in_progress" %}
                                <span class="badge bg-primary">In Progress</span>
                            {% elif task.status == "paused" %}
                                {% if task.requires_made_amount %}
                                <button type="button" class="btn btn-success w-100" onclick="showMadeAmountInput({{ task.id }}, '{{ task.batch.recipe.name if task.batch else task.description }}')">
                                    <i class="fas fa-check"></i> Finish & Enter Amount
                                </button>
                                {% else %}
                                <span class="badge bg-warning">Paused</span>
                                {% endif %}
                            {% elif task.status == "completed" %}
                                <span class="badge bg-success">Completed</span>
                            {% endif %}
                        </p>
                        
                        <!-- Task Summary Information -->
                        {% if task_summary %}
                        <div class="mt-3 p-3 bg-light border rounded">
                            <h6>Task Summary</h6>
                            <p><strong>Par Level:</strong> {{ "%.1f"|format(task_summary.par_level) }} {{ task_summary.par_unit_name }}</p>
                            
                            {% if task_summary.par_unit_equals %}
                            <p><strong>Par Unit Equals:</strong> {{ "%.2f"|format(task_summary.par_unit_equals) }} 
                            {% if task_summary.par_unit_equals_unit %}
                                {{ task_summary.par_unit_equals_unit }} per {{ task_summary.par_unit_name }}
                            {% endif %}
                            </p>
                            {% elif task_summary.par_unit_equals_type == 'par_unit_itself' %}
                            <p><strong>Par Unit Equals:</strong> 1 {{ task_summary.par_unit_name }} = 1 {{ task_summary.par_unit_name }}</p>
                            {% endif %}
                            
                            <p><strong>Initial Inventory:</strong> {{ "%.1f"|format(task_summary.initial_inventory) }} {{ task_summary.par_unit_name }}
                            {% if task_summary.initial_converted %}
                                ({{ "%.2f"|format(task_summary.initial_converted) }} {{ task_summary.par_unit_equals_unit }})
                            {% endif %}
                            <br><small class="text-muted">(Quantity entered in daily inventory)</small>
                            </p>
                            
                            {% if task_summary.made_amount %}
                            <p><strong>Made Amount:</strong> {{ task_summary.made_amount }} {{ task_summary.made_unit }} = {{ "%.2f"|format(task_summary.made_par_units) }} {{ task_summary.par_unit_name }}
                            {% if task_summary.made_converted %}
                                ({{ "%.2f"|format(task_summary.made_converted) }} {{ task_summary.par_unit_equals_unit }})
                            {% elif task_summary.made_quantity_equivalent %}
                                ({{ "%.1f"|format(task_summary.made_quantity_equivalent) }} {{ task_summary.made_quantity_unit }})
                            {% endif %}
                            {% if task.batch and not task.batch.variable_yield and task.scale_factor %}
                            <br><small class="text-muted">(Batch yield × scale: {{ task.batch.yield_amount }} × {{ task.scale_factor }} = {{ task_summary.made_amount }} {{ task_summary.made_unit }})</small>
                            {% elif task_summary.made_amount %}
                            <br><small class="text-muted">(Manual input: {{ task_summary.made_amount }} {{ task_summary.made_unit }})</small>
                            {% endif %}
                            </p>
                            {% endif %}
                            
                            <p><strong>Final Inventory:</strong> {{ "%.1f"|format(task_summary.final_inventory) }} {{ task_summary.par_unit_name }}
                            {% if task_summary.final_converted %}
                                ({{ "%.2f"|format(task_summary.final_converted) }} {{ task_summary.par_unit_equals_unit }})
                            {% endif %}
                            <br><small class="text-muted">(Initial + Made: {{ "%.1f"|format(task_summary.initial_inventory) }} + {{ "%.2f"|format(task_summary.made_amount_par_units) }} = {{ "%.1f"|format(task_summary.final_inventory) }} {{ task_summary.par_unit_name }})</small>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if task.started_at %}
                        <p><strong>Started:</strong> {{ task.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% endif %}
                        
                        {% if task.finished_at %}
                        <p><strong>Finished:</strong> {{ task.finished_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% endif %}
                        
                        {% if task.is_paused and task.paused_at %}
                        <p><strong>Paused at:</strong> {{ task.paused_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% endif %}
                        
                        {% if task.started_at %}
                        <p><strong>Total Time:</strong> {{ task.total_time_minutes }} minutes</p>
                        {% endif %}
                        
                        {% if task.total_pause_time > 0 %}
                        <p><strong>Pause Time:</strong> {{ (task.total_pause_time / 60)|round(1) }} minutes</p>
                        {% endif %}
                        
                        {% if task.finished_at and task.assigned_to %}
                        <p><strong>Labor Cost:</strong> 
                            <span class="text-success">${{ "%.2f"|format(task.labor_cost) }}</span>
                            <br><small class="text-muted">{{ task.total_time_minutes }} min × ${{ "%.2f"|format(task.highest_hourly_wage) }}/hr</small>
                            {% if task.assigned_employee_ids and task.assigned_employee_ids.split(',')|length > 1 %}
                            <br><small class="text-info">(Highest wage among team members)</small>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-industry"></i> Task Details</h5>
            </div>
            <div class="card-body">
                {% if task.batch %}
                <h6><i class="fas fa-industry"></i> Linked Batch</h6>
                <p><strong>Recipe:</strong> 
                    <a href="/batches/{{ task.batch.id }}" class="text-decoration-none">
                        {{ task.batch.recipe.name }}
                    </a>
                </p>
                <p><strong>Estimated Labor:</strong> {{ task.batch.estimated_labor_minutes }} min</p>
                <p><strong>Estimated Cost:</strong> ${{ "%.2f"|format(task.batch.estimated_labor_cost) }}</p>
                {% if task.finished_at and task.assigned_to %}
                <p><strong>This Task Cost:</strong> ${{ "%.2f"|format(task.labor_cost) }}</p>
                <p><strong>Variance:</strong> 
                    <span class="{% if task.labor_cost > task.batch.estimated_labor_cost %}text-danger{% else %}text-success{% endif %}">
                        {% if task.labor_cost > task.batch.estimated_labor_cost %}+{% endif %}${{ "%.2f"|format(task.labor_cost - task.batch.estimated_labor_cost) }}
                    </span>
                </p>
                {% endif %}
                {% elif task.janitorial_task %}
                <h6><i class="fas fa-broom"></i> Janitorial Task</h6>
                <p><strong>Description:</strong> {{ task.janitorial_task.description }}</p>
                <p><strong>Task Type:</strong> 
                    {% if task.janitorial_task.task_type == 'daily' %}
                        <span class="badge bg-primary">Daily Task</span>
                        <br><small class="text-muted">Automatically included in every inventory day</small>
                    {% else %}
                        <span class="badge bg-secondary">Manual Task</span>
                        <br><small class="text-muted">Added manually to specific days</small>
                    {% endif %}
                </p>
                {% if task.finished_at and task.assigned_to %}
                <p><strong>Labor Cost:</strong> ${{ "%.2f"|format(task.labor_cost) }}</p>
                <p><small class="text-muted">Pure labor cost - no food cost for janitorial tasks</small></p>
                {% endif %}
                {% else %}
                <h6><i class="fas fa-hand-paper"></i> Manual Task</h6>
                <p><strong>Description:</strong> {{ task.description }}</p>
                <p><strong>Task Type:</strong> <span class="badge bg-secondary">Manual</span></p>
                <p><small class="text-muted">Manually created task - no batch or janitorial template linked</small></p>
                {% if task.finished_at and task.assigned_to %}
                <p><strong>Labor Cost:</strong> ${{ "%.2f"|format(task.labor_cost) }}</p>
                {% endif %}
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-sticky-note"></i> Task Notes</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized %}
                <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/notes">
                    <div class="mb-3">
                        <textarea class="form-control" name="notes" rows="4" placeholder="Add notes about this task...">{{ task.notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Notes
                    </button>
                </form>
                {% else %}
                <div class="border p-3 bg-light">
                    {{ task.notes or 'No notes for this task.' }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Task Actions</h5>
            </div>
            <div class="card-body">
                {% if not inventory_day.finalized and current_user.role in ["admin", "manager", "user"] %}
                <div class="d-grid gap-2">
                    {% if task.status == "not_started" %}
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/start">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-play"></i> Start Task
                        </button>
                    </form>
                    {% elif task.status == "in_progress" %}
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/pause">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-pause"></i> Pause Task
                        </button>
                    </form>
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/finish">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check"></i> Finish Task
                        </button>
                    </form>
                    {% elif task.status == "paused" %}
                    <form method="post" action="/inventory/day/{{ inventory_day.id }}/tasks/{{ task.id }}/resume">
                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-play"></i> Resume Task
                        </button>
                    </form>
                    {% elif task.status == "completed" %}
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle"></i> Task Completed
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    {% if inventory_day.finalized %}
                    <i class="fas fa-lock"></i> Day is finalized
                    {% else %}
                    <i class="fas fa-eye"></i> View only
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-calendar-day"></i> Day Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Date:</strong> {{ inventory_day.date }}</p>
                <p><strong>Status:</strong> 
                    {% if inventory_day.finalized %}
                        <span class="badge bg-success">Finalized</span>
                    {% else %}
                        <span class="badge bg-warning">In Progress</span>
                    {% endif %}
                </p>
                {% if inventory_day.employees_working %}
                <p><strong>Employees Working:</strong></p>
                <ul class="list-unstyled">
                    {% set employee_ids = inventory_day.employees_working.split(',') %}
                    {% for emp_id in employee_ids %}
                        {% for emp in employees %}
                            {% if emp.id|string == emp_id %}
                            <li><i class="fas fa-user"></i> {{ emp.full_name or emp.username }}</li>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Scale Selection Modal (same as inventory_day.html)
function showScaleSelection(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/scale_options`)
        .then(response => response.json())
        .then(scales => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Batch Scale - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select batch scale to make:</label>
                                <select class="form-select" id="scaleSelect" required>
                                    <option value="">Choose scale...</option>
                                    ${scales.map(scale => 
                                        `<option value="${scale.key}" data-yield="${scale.yield}">${scale.label} - ${scale.yield}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="startTaskWithScale(${taskId})">Start Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading scale options:', error);
            alert('Error loading scale options');
        });
}

function startTaskWithScale(taskId) {
    const scaleSelect = document.getElementById('scaleSelect');
    const selectedScale = scaleSelect.value;
    
    if (!selectedScale) {
        alert('Please select a batch scale');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/start_with_scale`;
    form.style.display = 'none';
    
    const scaleInput = document.createElement('input');
    scaleInput.name = 'selected_scale';
    scaleInput.value = selectedScale;
    
    form.appendChild(scaleInput);
    document.body.appendChild(form);
    form.submit();
}

// Made Amount Input Modal (same as inventory_day.html)
function showMadeAmountInput(taskId, recipeName) {
    fetch(`/api/tasks/${taskId}/finish_requirements`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Amount Made - ${recipeName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Amount Made:</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="number" class="form-control" id="madeAmount" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-4" id="madeUnitSection" ${data.available_units.length === 1 ? 'style="display: none;"' : ''}>
                                        <select class="form-select" id="madeUnit" required>
                                            ${data.available_units.map(unit => 
                                                `<option value="${unit}">${unit}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                ${data.available_units.length === 1 ? `
                                <small class="text-info">Unit: ${data.available_units[0]}</small>
                                <input type="hidden" id="hiddenMadeUnit" value="${data.available_units[0]}">
                                ` : ''}
                            </div>
                            ${data.inventory_info ? `
                            <div class="alert alert-info">
                                <small>
                                    <strong>Current Inventory:</strong> ${data.inventory_info.current} ${data.inventory_info.par_unit_name}<br>
                                    <strong>Par Level:</strong> ${data.inventory_info.par_level} ${data.inventory_info.par_unit_name}
                                </small>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="finishTaskWithAmount(${taskId})">Finish Task</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error loading finish requirements:', error);
            alert('Error loading task requirements');
        });
}

function finishTaskWithAmount(taskId) {
    const madeAmount = document.getElementById('madeAmount').value;
    const madeUnitInput = document.getElementById('madeUnit');
    
    const madeUnit = madeUnitInput.value;
    
    if (!madeAmount || !madeUnit) {
        alert('Please enter amount made and select unit');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/inventory/day/{{ inventory_day.id }}/tasks/${taskId}/finish_with_amount`;
    form.style.display = 'none';
    
    const amountInput = document.createElement('input');
    amountInput.name = 'made_amount';
    amountInput.value = madeAmount;
    
    const unitInput = document.createElement('input');
    unitInput.name = 'made_unit';
    unitInput.value = madeUnit;
    
    form.appendChild(amountInput);
    form.appendChild(unitInput);
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}