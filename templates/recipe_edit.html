{% extends "base.html" %}

{% block title %}Edit {{ recipe.name }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-edit"></i> Edit Recipe: {{ recipe.name }}</h1>
        <a href="/recipes/{{ recipe.id }}" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Recipe
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-edit"></i> Recipe Information</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/recipes/{{ recipe.id }}/edit" id="recipeEditForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Recipe Name</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ recipe.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Category</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if recipe.category_id == cat.id %}selected{% endif %}>{{ cat.icon or 'ðŸ”˜' }} {{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="4">{{ recipe.instructions or '' }}</textarea>
                    </div>
                    
                    <h6>Ingredients:</h6>
                    <div class="mb-3">
                        <label for="ingredientSearch" class="form-label">Search & Select Ingredient</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="ingredientSearch" 
                                   placeholder="Type to search ingredients..." autocomplete="off">
                            <div id="ingredientDropdown" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;">
                                <!-- Ingredient options will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="selectedIngredients" class="mb-3">
                        <!-- Selected ingredients will appear here -->
                    </div>
                    
                    <input type="hidden" name="ingredients_data" id="ingredientsData">
                    
                    <div class="d-flex justify-content-between">
                        <a href="/recipes/{{ recipe.id }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let selectedIngredients = [];
let allIngredients = [];
let currentSelectedIngredient = null;

document.addEventListener('DOMContentLoaded', function() {
    // Load existing ingredients
    {% for ri in recipe_ingredients %}
    selectedIngredients.push({
        ingredient_id: {{ ri.ingredient_id }},
        ingredient_name: "{{ ri.ingredient.name }}",
        unit: "{{ ri.unit }}",
        quantity: {{ ri.quantity }},
        estimated_cost: {{ ri.cost or 0 }}
    });
    {% endfor %}
    
    updateSelectedIngredientsDisplay();
    
    // Load all ingredients for dropdown
    loadAllIngredients();
    
    const ingredientSearch = document.getElementById('ingredientSearch');
    const dropdown = document.getElementById('ingredientDropdown');
    
    // Search functionality
    ingredientSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        filterIngredients(query);
    });
    
    // Show all ingredients when focused
    ingredientSearch.addEventListener('focus', function() {
        if (allIngredients.length > 0) {
            filterIngredients('');
        }
        dropdown.style.display = 'block';
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#ingredientSearch') && !e.target.closest('#ingredientDropdown')) {
            dropdown.style.display = 'none';
        }
    });
    
    // Form submission
    document.getElementById('recipeEditForm').addEventListener('submit', function(e) {
        document.getElementById('ingredientsData').value = JSON.stringify(selectedIngredients);
    });
});

async function loadAllIngredients() {
    try {
        const response = await fetch('/api/ingredients/all');
        if (!response.ok) {
            throw new Error('Failed to load ingredients');
        }
        allIngredients = await response.json();
        console.log('Loaded ingredients:', allIngredients);
        // Don't show dropdown on page load - wait for user interaction
    } catch (error) {
        console.error('Error loading ingredients:', error);
        // Don't show error dropdown on page load either
    }
}

function filterIngredients(query) {
    const dropdown = document.getElementById('ingredientDropdown');
    
    const filteredIngredients = allIngredients.filter(ingredient => 
        ingredient.name.toLowerCase().includes(query) ||
        (ingredient.category && ingredient.category.toLowerCase().includes(query))
    );
    
    dropdown.innerHTML = '';
    
    if (filteredIngredients.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item-text text-muted">No ingredients found</div>';
    } else {
        filteredIngredients.forEach(ingredient => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `
                <strong>${ingredient.name}</strong>
                ${ingredient.category ? `<br><small class="text-muted">${ingredient.category}</small>` : ''}
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectIngredient(ingredient);
                document.getElementById('ingredientSearch').value = ingredient.name;
                dropdown.style.display = 'none';
            });
            
            dropdown.appendChild(item);
        });
    }
    
    if (query || document.getElementById('ingredientSearch') === document.activeElement) {
        dropdown.style.display = 'block';
    }
}

function selectIngredient(ingredient) {
    console.log('Selected ingredient:', ingredient);
    
    // Check if ingredient already selected
    if (selectedIngredients.find(si => si.ingredient_id === ingredient.id)) {
        alert('This ingredient is already added to the recipe.');
        return;
    }
    
    // Check if ingredient has usage units
    if (!ingredient.available_units || ingredient.available_units.length === 0) {
        alert('This ingredient has no available units defined.');
        return;
    }
    
    // Store current ingredient and show unit selection
    currentSelectedIngredient = ingredient;
    showUnitSelection(ingredient);
}

function showUnitSelection(ingredient) {
    console.log('Showing unit selection for:', ingredient);
    
    const availableUnits = ingredient.available_units;
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'ingredientModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ${ingredient.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Unit</label>
                        <select class="form-select" id="usageUnitSelect">
                            ${availableUnits.map(unit => 
                                `<option value="${unit}" data-ingredient-id="${ingredient.id}">${formatUnitDisplay(unit)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantityInput" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estimated cost: $<span id="estimatedCost">0.00</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addIngredientToRecipe()">Add Ingredient</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Update cost estimate when quantity or unit changes
    const quantityInput = modal.querySelector('#quantityInput');
    const usageUnitSelect = modal.querySelector('#usageUnitSelect');
    const estimatedCost = modal.querySelector('#estimatedCost');
    
    function updateCost() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const selectedUnit = usageUnitSelect.value;
        const ingredientId = usageUnitSelect.selectedOptions[0]?.dataset.ingredientId;
        
        if (quantity > 0 && selectedUnit && ingredientId) {
            // Calculate cost using ingredient's cost per unit method
            fetch(`/api/ingredients/${ingredientId}/cost_per_unit/${encodeURIComponent(selectedUnit)}`)
                .then(response => response.json())
                .then(data => {
                    const cost = quantity * data.cost_per_unit;
                    estimatedCost.textContent = cost.toFixed(2);
                })
                .catch(error => {
                    console.error('Error calculating cost:', error);
                    estimatedCost.textContent = '0.00';
                });
        } else {
            estimatedCost.textContent = '0.00';
        }
    }
    
    quantityInput.addEventListener('input', updateCost);
    usageUnitSelect.addEventListener('change', updateCost);
    
    // Initial cost calculation with slight delay
    setTimeout(updateCost, 100);
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addIngredientToRecipe() {
    console.log('Adding ingredient to recipe...');
    
    const modal = document.getElementById('ingredientModal');
    const usageUnitSelect = document.querySelector('#usageUnitSelect');
    const quantityInput = document.querySelector('#quantityInput');
    
    const quantity = parseFloat(quantityInput.value);
    if (!quantity || quantity <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    const selectedUnit = usageUnitSelect.value;
    const estimatedCost = parseFloat(document.querySelector('#estimatedCost').textContent);
    
    console.log('Adding ingredient:', {
        ingredient_id: currentSelectedIngredient.id,
        ingredient_name: currentSelectedIngredient.name,
        unit: selectedUnit,
        quantity: quantity,
        estimated_cost: estimatedCost
    });
    
    // Add to selected ingredients
    selectedIngredients.push({
        ingredient_id: currentSelectedIngredient.id,
        ingredient_name: currentSelectedIngredient.name,
        unit: selectedUnit,
        quantity: quantity,
        estimated_cost: estimatedCost
    });
    
    // Update display
    updateSelectedIngredientsDisplay();
    
    // Clear search field
    document.getElementById('ingredientSearch').value = '';
    
    // Close modal
    bootstrap.Modal.getInstance(modal).hide();
}

function updateSelectedIngredientsDisplay() {
    const container = document.getElementById('selectedIngredients');
    
    console.log('Updating display with ingredients:', selectedIngredients);
    
    if (selectedIngredients.length === 0) {
        container.innerHTML = '<p class="text-muted">No ingredients added yet.</p>';
        return;
    }
    
    let html = '<h6>Selected Ingredients:</h6>';
    let totalCost = 0;
    
    selectedIngredients.forEach((ingredient, index) => {
        totalCost += ingredient.estimated_cost;
        html += `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${ingredient.ingredient_name}</strong><br>
                            <small>${ingredient.quantity} ${formatUnitDisplay(ingredient.unit)} - $${ingredient.estimated_cost.toFixed(2)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeIngredient(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `<div class="alert alert-info"><strong>Estimated Total Cost: $${totalCost.toFixed(2)}</strong></div>`;
    container.innerHTML = html;
}

function removeIngredient(index) {
    selectedIngredients.splice(index, 1);
    updateSelectedIngredientsDisplay();
}

function formatUnitDisplay(unit) {
    // Convert internal unit format to display format
    const unitDisplayMap = {
        '3_4_cup': '3/4 cup',
        '2_3_cup': '2/3 cup', 
        '1_2_cup': '1/2 cup',
        '1_3_cup': '1/3 cup',
        '1_4_cup': '1/4 cup',
        '1_8_cup': '1/8 cup'
    };
    
    return unitDisplayMap[unit] || unit;
}
</script>
{% endblock %}