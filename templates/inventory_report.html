{% extends "base.html" %}

{% block title %}Inventory Report {{ inventory_day.date }} - Food Cost Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1><i class="fas fa-chart-bar"></i> Inventory Report: {{ inventory_day.date }}</h1>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#emailReportModal">
                    <i class="fas fa-envelope"></i> Email Report
                </button>
                <a href="/inventory" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Inventory
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Day Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3>{{ total_tasks }}</h3>
                                <p class="mb-0">Total Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3>{{ completed_tasks }}</h3>
                                <p class="mb-0">Completed Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h3>{{ below_par_items }}</h3>
                                <p class="mb-0">Below Par Items</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3>{{ "%.1f"|format((completed_tasks / total_tasks * 100) if total_tasks > 0 else 0) }}%</h3>
                                <p class="mb-0">Completion Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if inventory_day.employees_working %}
                <div class="mt-3">
                    <h6>Employees Working:</h6>
                    {% set employee_ids = inventory_day.employees_working.split(',') %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for emp_id in employee_ids %}
                            {% for emp in employees %}
                                {% if emp.id|string == emp_id %}
                                <span class="badge bg-secondary">{{ emp.full_name or emp.username }}</span>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% set tasks_with_notes = started_tasks|selectattr('notes')|list %}
{% if inventory_day.global_notes or tasks_with_notes %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sticky-note"></i> Notes</h5>
            </div>
            <div class="card-body">
                {% if inventory_day.global_notes %}
                <div class="mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-calendar-day text-primary me-3 mt-1" style="font-size: 18px;"></i>
                        <div class="flex-grow-1">
                            <strong class="text-primary">Daily Note:</strong>
                            <p class="mb-0 mt-1">{{ inventory_day.global_notes }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% for task in started_tasks|sort(attribute='started_at') %}
                    {% if task.notes %}
                    <div class="{% if not loop.first or inventory_day.global_notes %}mt-3{% endif %}">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-circle text-danger me-3 mt-1" style="font-size: 10px;"></i>
                            <div class="flex-grow-1">
                                <strong class="text-danger">{{ task.description }}</strong>
                                {% if task.assigned_employee_ids %}
                                    {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                    {% if employee_ids|length > 1 %}
                                        <small class="text-muted">- Team of {{ employee_ids|length }}</small>
                                    {% else %}
                                        {% for emp_id in employee_ids %}
                                            {% for emp in employees %}
                                                {% if emp.id|string == emp_id.strip() %}
                                                    <small class="text-muted">- {{ emp.full_name or emp.username }}</small>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endif %}
                                {% elif task.assigned_to %}
                                    <small class="text-muted">- {{ task.assigned_to.full_name or task.assigned_to.username }}</small>
                                {% endif %}
                                <p class="mb-0 mt-1">{{ task.notes }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Task Report</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Time (min)</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in started_tasks %}
                            <tr>
                                <td>
                                    <small>{{ task.description }}</small>
                                </td>
                                <td>
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <span class="text-info"><strong>Team of {{ employee_ids|length }}</strong></span>
                                            <br>
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id.strip() %}
                                                        <span class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id.strip() %}
                                                        <small>{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        <small>{{ task.assigned_to.full_name or task.assigned_to.username }}</small>
                                    {% else %}
                                        <small class="text-warning">Unassigned</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.status == "not_started" %}
                                        <span class="badge bg-secondary">Not Started</span>
                                    {% elif task.status == "in_progress" %}
                                        <span class="badge bg-primary">In Progress</span>
                                    {% elif task.status == "paused" %}
                                        <span class="badge bg-warning">Paused</span>
                                    {% elif task.status == "completed" %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ task.total_time_minutes }}
                                </td>
                                <td>
                                    {% if task.janitorial_task_id %}
                                        ðŸ§¹ Janitorial
                                    {% elif task.inventory_item_id and not task.inventory_item %}
                                        <span class="text-muted">Item Removed</span>
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'ï¿½ï¿½' }} {{ task.inventory_item.category.name }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }} {{ task.inventory_item.batch.category.name }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'ðŸ”˜' }} {{ task.batch.category.name }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'ðŸ”˜' }} {{ task.category.name }}
                                    {% else %}
                                        ðŸ”˜ Uncategorized
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/inventory/day/{{ inventory_day.date }}/tasks/{{ task.slug }}" class="btn btn-sm {% if task.notes %}btn-outline-danger{% else %}btn-outline-info{% endif %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Inventory Status</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Par Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_day_items %}
                            {% set is_below_par = item.quantity < item.inventory_item.par_level %}
                            {% set is_on_par = item.quantity == item.inventory_item.par_level %}
                            {% set is_near_par = item.quantity == item.inventory_item.par_level + 1 %}
                            {% set is_good = item.quantity >= item.inventory_item.par_level + 2 %}
                            <tr class="{% if is_below_par %}table-danger{% elif is_on_par %}table-info{% elif is_near_par %}table-warning{% endif %}">
                                <td>{{ item.inventory_item.name }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.inventory_item.par_level }}</td>
                                <td>
                                    {% if is_below_par %}
                                        <span class="badge bg-danger">Below Par</span>
                                    {% elif is_on_par %}
                                        <span class="badge bg-info">On Par</span>
                                    {% elif is_near_par %}
                                        <span class="badge bg-warning">Near Par</span>
                                    {% else %}
                                        <span class="badge bg-success">Good</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if unstarted_tasks %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-exclamation-triangle"></i> Tasks Not Completed ({{ unstarted_tasks|length }})</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">The following tasks were generated but never started during this shift:</p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in unstarted_tasks %}
                            <tr>
                                <td><small>{{ task.description }}</small></td>
                                <td>
                                    <small>
                                    {% if task.janitorial_task_id %}
                                        ðŸ§¹ Janitorial
                                    {% elif task.inventory_item_id and not task.inventory_item %}
                                        <span class="text-muted">Item Removed</span>
                                    {% elif task.inventory_item and task.inventory_item.category %}
                                        {{ task.inventory_item.category.icon or 'ðŸ”˜' }} {{ task.inventory_item.category.name }}
                                    {% elif task.inventory_item and task.inventory_item.batch and task.inventory_item.batch.category %}
                                        {{ task.inventory_item.batch.category.icon or 'ðŸ”˜' }} {{ task.inventory_item.batch.category.name }}
                                    {% elif task.batch and task.batch.category %}
                                        {{ task.batch.category.icon or 'ðŸ”˜' }} {{ task.batch.category.name }}
                                    {% elif task.category %}
                                        {{ task.category.icon or 'ðŸ”˜' }} {{ task.category.name }}
                                    {% else %}
                                        ðŸ”˜ Uncategorized
                                    {% endif %}
                                    </small>
                                </td>
                                <td><span class="badge bg-secondary">Not Started</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Time Analysis</h5>
            </div>
            <div class="card-body">
                {% set total_time = started_tasks|sum(attribute='total_time_minutes') %}
                {% set completed_time = started_tasks|selectattr('finished_at')|sum(attribute='total_time_minutes') %}

                {% if total_shift_duration %}
                <div class="alert alert-info">
                    <h6 class="mb-3"><i class="fas fa-business-time"></i> Shift Summary</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5>{{ "%.1f"|format(total_shift_duration / 60) }} hrs</h5>
                                <small class="text-muted">Total Shift Duration</small>
                                <div class="text-muted" style="font-size: 0.85rem;">({{ "%.0f"|format(total_shift_duration) }} min)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5>{{ "%.1f"|format(total_time / 60) }} hrs</h5>
                                <small class="text-muted">Active Task Time</small>
                                <div class="text-muted" style="font-size: 0.85rem;">({{ total_time }} min)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5>{{ "%.1f"|format(off_task_time / 60) }} hrs</h5>
                                <small class="text-muted">Off-Task Time</small>
                                <div class="text-muted" style="font-size: 0.85rem;">({{ "%.0f"|format(off_task_time) }} min)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5>{{ "%.0f"|format(shift_efficiency) }}%</h5>
                                <small class="text-muted">Shift Efficiency</small>
                                <div class="text-muted" style="font-size: 0.85rem;">(Task Time / Total Time)</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <h6 class="mt-3">Task Time Breakdown:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <h4>{{ total_time }} min</h4>
                            <p class="text-muted">Total Task Time</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <h4>{{ completed_time }} min</h4>
                            <p class="text-muted">Completed Task Time</p>
                        </div>
                    </div>
                </div>
                
                {% if started_tasks|selectattr('finished_at')|list %}
                <h6 class="mt-3">Completed Tasks Detail:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Employee</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration</th>
                                <th>Linked Batch</th>
                                <th>Labor Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in started_tasks|selectattr('finished_at') %}
                            <tr>
                                <td><small>{{ task.description }}</small></td>
                                <td>
                                    {% if task.assigned_employee_ids %}
                                        {% set employee_ids = task.assigned_employee_ids.split(',') %}
                                        {% if employee_ids|length > 1 %}
                                            <small><strong>Team of {{ employee_ids|length }}</strong></small>
                                            <br>
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id.strip() %}
                                                        <small class="badge bg-secondary me-1">{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            {% for emp_id in employee_ids %}
                                                {% for emp in employees %}
                                                    {% if emp.id|string == emp_id.strip() %}
                                                        <small>{{ emp.full_name or emp.username }}</small>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% elif task.assigned_to %}
                                        <small>{{ task.assigned_to.full_name or task.assigned_to.username }}</small>
                                    {% else %}
                                        <small class="text-warning">Unassigned</small>
                                    {% endif %}
                                </td>
                                <td><small>{{ task.started_at.strftime('%H:%M') if task.started_at else '-' }}</small></td>
                                <td><small>{{ task.finished_at.strftime('%H:%M') if task.finished_at else '-' }}</small></td>
                                <td><small>{{ task.total_time_minutes }} min</small></td>
                                <td>
                                    {% if task.batch and task.batch.recipe %}
                                        <small><a href="/batches/{{ task.batch.slug }}" class="text-decoration-none">{{ task.batch.recipe.name }}
                                        {% if task.batch.recipe.deleted %}
                                        <span class="text-danger">(removed)</span>
                                        {% endif %}
                                        </a></small>
                                    {% elif task.batch %}
                                        <small class="text-warning">Recipe not found</small>
                                    {% elif task.janitorial_task %}
                                        <small class="text-warning">Janitorial Task</small>
                                    {% elif task.inventory_item_id and not task.inventory_item %}
                                        <small class="text-muted">Item Removed</small>
                                    {% else %}
                                        <small class="text-muted">None</small>
                                    {% endif %}
                                </td>
                                <td><small>${{ "%.2f"|format(task.labor_cost) }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Email Report Modal -->
<div class="modal fade" id="emailReportModal" tabindex="-1" aria-labelledby="emailReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailReportModalLabel">
                    <i class="fas fa-envelope"></i> Email Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="emailReportForm" action="/api/inventory/{{ inventory_day.id }}/email-report" method="post">
                <div class="modal-body">
                    <p class="text-muted">Select recipients for this daily report:</p>

                    {% set managers_admins = employees | selectattr('role', 'in', ['manager', 'admin']) | selectattr('is_active', 'equalto', true) | list %}
                    {% set recipients_with_email = managers_admins | selectattr('email') | list %}

                    {% if recipients_with_email %}
                        <div class="list-group">
                            {% for employee in recipients_with_email %}
                            <label class="list-group-item d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" name="recipient_ids" value="{{ employee.id }}">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ employee.full_name or employee.username }}</div>
                                    <small class="text-muted">{{ employee.email }}</small>
                                    <span class="badge {{ 'bg-danger' if employee.role == 'admin' else 'bg-warning' }} ms-2">
                                        {{ employee.role.title() }}
                                    </span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllRecipients(true)">
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllRecipients(false)">
                                Deselect All
                            </button>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            No managers or admins have email addresses configured. Please add email addresses to employee profiles to enable email reports.
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {% if recipients_with_email %}
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Report
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleAllRecipients(selectAll) {
    const checkboxes = document.querySelectorAll('input[name="recipient_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
}

document.getElementById('emailReportForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const checkedRecipients = formData.getAll('recipient_ids');

    if (checkedRecipients.length === 0) {
        alert('Please select at least one recipient');
        return;
    }

    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            alert('Report sent successfully to ' + result.recipients_count + ' recipient(s)!');
            bootstrap.Modal.getInstance(document.getElementById('emailReportModal')).hide();
        } else {
            alert('Error sending report: ' + (result.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error sending report: ' + error.message);
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    }
});
</script>
{% endblock %}