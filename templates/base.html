<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Food Cost Management{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand { font-weight: bold; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #2c5aa0; border-color: #2c5aa0; }
        .btn-primary:hover { background-color: #1e3f73; border-color: #1e3f73; }
        .table th { background-color: #f8f9fa; }
        .below-par { background-color: #ffcccc !important; }
        .near-par { background-color: #fff3cd !important; }
        .sidebar { min-height: 100vh; background-color: #f8f9fa; }
        .main-content { padding: 20px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/home">
                <i class="fas fa-utensils"></i> Food Cost Management
            </a>
            
            {% if current_user %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if current_user.role == "admin" %}
                    <li class="nav-item">
                        <a class="nav-link" href="/employees"><i class="fas fa-users"></i> Employees</a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="/ingredients"><i class="fas fa-carrot"></i> Ingredients</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/recipes"><i class="fas fa-book"></i> Recipes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/batches"><i class="fas fa-industry"></i> Batches</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dishes"><i class="fas fa-utensils"></i> Dishes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/inventory"><i class="fas fa-boxes"></i> Inventory</a>
                    </li>
                    {% if current_user.role == "admin" %}
                    <li class="nav-item">
                        <a class="nav-link" href="/utilities"><i class="fas fa-bolt"></i> Utilities</a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> {{ current_user.full_name or current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <main class="col-12 main-content">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('Base template loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, looking for tables...');
            
            // Find all tables with sortable class
            const sortableTables = document.querySelectorAll('.table-sortable');
            console.log('Found sortable tables:', sortableTables.length);
            
            if (sortableTables.length === 0) {
                console.log('No tables with .table-sortable class found');
                // Let's check for any tables at all
                const allTables = document.querySelectorAll('table');
                console.log('Found total tables:', allTables.length);
                
                allTables.forEach((table, index) => {
                    console.log(`Table ${index} classes:`, table.className);
                });
            }
            
            sortableTables.forEach((table, tableIndex) => {
                console.log(`Initializing table ${tableIndex}`);
                initializeSortableTable(table);
            });
        });
        
        function initializeSortableTable(table) {
            const headers = table.querySelectorAll('thead th[data-sortable]');
            console.log('Found sortable headers:', headers.length);
            
            if (headers.length === 0) {
                console.log('No headers with data-sortable attribute found');
                // Let's check all headers
                const allHeaders = table.querySelectorAll('thead th');
                console.log('Found total headers:', allHeaders.length);
                
                allHeaders.forEach((header, index) => {
                    console.log(`Header ${index}:`, header.textContent, 'attributes:', header.attributes);
                });
            }
            
            headers.forEach((header, index) => {
                console.log(`Setting up header ${index}:`, header.textContent);
                
                // Add sorting indicator
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.innerHTML += ' <i class="fas fa-sort text-muted sort-icon"></i>';
                
                // Add click event
                header.addEventListener('click', function() {
                    console.log('Sorting column:', index, header.textContent);
                    sortTable(table, index, header);
                });
            });
        }
        
        function sortTable(table, columnIndex, header) {
            console.log('sortTable called for column:', columnIndex);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const sortType = header.getAttribute('data-sort-type') || 'text';
            const currentDirection = header.getAttribute('data-sort-direction') || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            
            console.log('Sorting:', sortType, 'direction:', newDirection, 'rows:', rows.length);
            
            // Clear all other sort indicators
            table.querySelectorAll('thead th .sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort text-muted sort-icon';
            });
            
            // Update current header sort indicator
            const sortIcon = header.querySelector('.sort-icon');
            if (newDirection === 'asc') {
                sortIcon.className = 'fas fa-sort-up text-primary sort-icon';
            } else {
                sortIcon.className = 'fas fa-sort-down text-primary sort-icon';
            }
            
            header.setAttribute('data-sort-direction', newDirection);
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                let aValue = getCellValue(aCell, sortType);
                let bValue = getCellValue(bCell, sortType);
                
                console.log('Comparing:', aValue, 'vs', bValue);
                
                // Handle different sort types
                if (sortType === 'number') {
                    aValue = parseFloat(aValue) || 0;
                    bValue = parseFloat(bValue) || 0;
                } else if (sortType === 'currency') {
                    aValue = parseCurrency(aValue);
                    bValue = parseCurrency(bValue);
                } else if (sortType === 'date') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else {
                    // Text sorting - case insensitive
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                if (aValue < bValue) {
                    return newDirection === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return newDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            console.log('Sorting completed');
        }
        
        function getCellValue(cell, sortType) {
            // Get the text content, but handle special cases
            let value = cell.textContent.trim();
            
            // Handle badges and icons - extract just the text
            const strongElement = cell.querySelector('strong');
            if (strongElement && sortType === 'text') {
                value = strongElement.textContent.trim();
            }
            
            // Handle category columns with icons
            if (value.match(/^[\u{1F000}-\u{1F9FF}]/u)) {
                // Remove emoji from the beginning
                value = value.replace(/^[\u{1F000}-\u{1F9FF}\s]+/u, '').trim();
            }
            
            // Handle multi-line content - use first line
            if (value.includes('\n')) {
                value = value.split('\n')[0].trim();
            }
            
            return value;
        }
        
        function parseCurrency(value) {
            // Extract numeric value from currency strings like "$1.23"
            const match = value.match(/\$?([0-9,]+\.?[0-9]*)/);
            return match ? parseFloat(match[1].replace(/,/g, '')) : 0;
        }
    </script>
    
    <style>
        .table-sortable thead th[data-sortable] {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        
        .table-sortable thead th[data-sortable]:hover {
            background-color: #f8f9fa;
        }
        
        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }
    </style>
    {% block scripts %}{% endblock %}
</body>
</html>